<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grim√≥rio Digital - Ficha</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <!-- SEU SISTEMA DE ARMAZENAMENTO -->
    <script src="grimorio-core.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        cinzel: ['Cinzel', 'serif'],
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        theme: {
                            bg: '#0a0a0c',
                            panel: '#0f0f12',
                            border: '#2a2a2e',
                            text: '#e8e4dc',
                            blue: '#4a9eff',
                            orange: '#ff6b35',
                            green: '#10b981',
                            purple: '#8b5cf6',
                            pink: '#ec4899',
                            yellow: '#f59e0b'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0a0a0c; color: #e8e4dc; }
        
        /* Anima√ß√µes */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .anim-entry { animation: fadeInUp 0.6s ease-out forwards; opacity: 0; }
        .delay-1 { animation-delay: 0.1s; }
        .delay-2 { animation-delay: 0.2s; }
        .delay-3 { animation-delay: 0.3s; }
        
        /* Inputs */
        .custom-input {
            width: 100%;
            background: transparent;
            border-bottom: 1px solid #2a2a2e;
            color: #e8e4dc;
            padding: 0.5rem 0;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
        }
        .custom-input:focus { 
            border-bottom-color: #4a9eff; 
            outline: none; 
            box-shadow: 0 1px 0 0 #4a9eff;
        }
        .custom-input.orange:focus { border-bottom-color: #ff6b35; }
        
        .custom-textarea {
            width: 100%;
            background: #0a0a0c;
            border: 1px solid #2a2a2e;
            color: #e8e4dc;
            padding: 0.75rem;
            border-radius: 0.375rem;
            resize: vertical;
            min-height: 100px;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
            line-height: 1.5;
        }
        .custom-textarea:focus { 
            border-color: #4a9eff; 
            outline: none;
            box-shadow: 0 0 0 1px rgba(74, 158, 255, 0.1);
        }
        .custom-textarea.orange:focus { border-color: #ff6b35; }

        /* Avatar Upload */
        .avatar-upload {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: all 0.3s;
        }
        .avatar-upload:hover {
            transform: scale(1.02);
            border-color: #4a9eff;
        }
        .avatar-placeholder { 
            transition: all 0.3s;
            backdrop-filter: blur(2px);
        }
        .avatar-upload:hover .avatar-placeholder { 
            background-color: rgba(0, 0, 0, 0.7); 
        }
        
        /* Feedback */
        .feedback-success {
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Cards especiais */
        .card-highlight {
            position: relative;
            overflow: hidden;
        }
        .card-highlight::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, currentColor, transparent);
        }
    </style>
</head>
<body class="min-h-screen font-sans pb-20">

    <!-- NAVEGA√á√ÉO -->
    <nav class="w-full bg-[#0f0f12]/95 backdrop-blur-sm border-b border-theme-border sticky top-0 z-50 mb-8">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-between gap-4 py-4">
                <!-- Voltar para Hub -->
                <a href="index.html" class="flex items-center gap-3 group">
                    <div class="p-2 rounded-lg bg-[#4a9eff]/10 border border-[#4a9eff]/20 group-hover:bg-[#4a9eff]/20 transition-colors">
                        <i data-lucide="arrow-left" class="w-5 h-5 text-theme-blue"></i>
                    </div>
                    <div>
                        <div class="text-sm font-medium text-theme-text group-hover:text-theme-blue transition-colors">Voltar ao Hub</div>
                        <div class="text-xs text-[#606060]">Grim√≥rio Digital</div>
                    </div>
                </a>
                
                <!-- Bot√µes principais -->
                <div class="flex items-center gap-2">
                    <button onclick="salvarEAplicar()" 
                            id="btn-salvar-aplicar"
                            class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-theme-blue to-cyan-600 rounded-lg text-white text-sm font-medium hover:opacity-90 transition-all active:scale-95">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        <span>Salvar no Perfil</span>
                    </button>
                    
                    <a href="status.html" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-theme-orange to-orange-600 rounded-lg text-white text-sm font-medium hover:opacity-90 transition-all">
                        <i data-lucide="zap" class="w-4 h-4"></i>
                        <span>Ir para Status</span>
                    </a>
                </div>
            </div>
        </div>
        <div class="h-[1px] bg-gradient-to-r from-transparent via-theme-blue to-transparent"></div>
    </nav>

    <div class="max-w-6xl mx-auto px-4 space-y-6">

        <!-- CABE√áALHO COM AVISO -->
        <div class="anim-entry">
            <div class="bg-gradient-to-r from-[#0f0f12] to-[#0f0f12] border border-theme-border p-4 rounded-lg">
                <div class="flex items-start gap-3">
                    <div class="p-2 rounded-lg bg-[#4a9eff]/10">
                        <i data-lucide="info" class="w-5 h-5 text-theme-blue"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-cinzel font-semibold text-white mb-1">Informa√ß√µes do Perfil Ativo</h3>
                        <p class="text-sm text-[#a0a0a0]">
                            Esta ficha ser√° salva diretamente no <span class="text-theme-blue font-medium">Perfil Ativo</span>. 
                            Tudo que voc√™ preencher aqui aparecer√° automaticamente no Hub Central.
                        </p>
                        <div class="mt-3 flex items-center gap-4 text-sm">
                            <div id="profile-status" class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                                <span class="text-[#a0a0a0]" id="profile-name">Carregando...</span>
                            </div>
                            <div class="text-xs text-[#606060]">‚Ä¢</div>
                            <div class="text-xs text-[#606060]" id="profile-last-update">√öltima atualiza√ß√£o: -</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- T√çTULO DA FICHA -->
        <header class="flex items-center gap-4 mb-8 anim-entry delay-1">
            <div class="p-3 rounded-lg bg-[#4a9eff]/10 border border-[#4a9eff]/20">
                <i data-lucide="scroll-text" class="w-8 h-8 text-theme-blue"></i>
            </div>
            <div>
                <h1 class="text-3xl font-cinzel font-bold text-white">Ficha do Personagem</h1>
                <p class="text-gray-400">Preencha sua ficha completa - Tudo ser√° salvo automaticamente</p>
            </div>
        </header>

        <!-- SE√á√ÉO 1: IDENTIDADE E AVATAR -->
        <section class="bg-theme-panel border border-theme-border p-6 rounded-lg anim-entry delay-1 card-highlight">
            <h3 class="flex items-center gap-2 font-cinzel text-lg font-semibold text-theme-blue mb-6">
                <i data-lucide="user" class="w-5 h-5"></i> 
                <span>Identidade & Avatar</span>
                <span class="text-xs font-normal text-[#606060] ml-auto">(Salva automaticamente)</span>
            </h3>

            <div class="flex flex-col md:flex-row gap-8">
                <!-- Avatar -->
                <div class="flex-shrink-0 w-full md:w-48">
                    <div class="sticky top-32">
                        <div class="relative w-full aspect-square rounded-lg border-2 border-dashed border-theme-border hover:border-theme-blue cursor-pointer overflow-hidden group avatar-upload bg-[#0a0a0c]" 
                             id="avatar-container"
                             onclick="document.getElementById('file-upload').click()">
                            
                            <input type="file" id="file-upload" class="hidden" accept="image/*" onchange="previewImage(event)">
                            
                            <div class="avatar-placeholder absolute inset-0 flex flex-col items-center justify-center text-center p-4">
                                <i data-lucide="camera" class="w-10 h-10 text-[#606060] mb-3 group-hover:text-theme-blue transition-colors"></i>
                                <span class="text-sm text-[#808080] group-hover:text-theme-blue">Clique para adicionar imagem</span>
                                <span class="text-xs text-[#404040] mt-1">Recomendado: 400x400px</span>
                            </div>
                        </div>
                        
                        <div class="mt-3 flex justify-center gap-2">
                            <button onclick="removerAvatar()" class="text-xs text-[#808080] hover:text-red-400 transition-colors">
                                <i data-lucide="x" class="w-3 h-3 inline mr-1"></i> Remover
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Informa√ß√µes B√°sicas -->
                <div class="flex-grow">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs uppercase tracking-widest text-[#606060] font-cinzel mb-2">Nome do Personagem *</label>
                            <input type="text" id="inp-nome" placeholder="Ex: Aelarion" class="custom-input data-field" required>
                        </div>
                        
                        <div>
                            <label class="block text-xs uppercase tracking-widest text-[#606060] font-cinzel mb-2">T√≠tulo / Ep√≠teto</label>
                            <input type="text" id="inp-titulo" placeholder="Ex: O Guardi√£o das Sombras" class="custom-input data-field">
                        </div>
                        
                        <div>
                            <label class="block text-xs uppercase tracking-widest text-[#606060] font-cinzel mb-2">N√≠vel</label>
                            <input type="number" id="inp-nivel" min="1" max="20" value="1" class="custom-input data-field">
                        </div>
                        
                        <div>
                            <label class="block text-xs uppercase tracking-widest text-[#606060] font-cinzel mb-2">Idade</label>
                            <input type="text" id="inp-idade" placeholder="Ex: 25 anos, 150 anos..." class="custom-input data-field">
                        </div>
                        
                        <div>
                            <label class="block text-xs uppercase tracking-widest text-[#606060] font-cinzel mb-2">Altura</label>
                            <input type="text" id="inp-altura" placeholder="Ex: 1.75m, 6'2''..." class="custom-input data-field">
                        </div>
                        
                        <div>
                            <label class="block text-xs uppercase tracking-widest text-[#606060] font-cinzel mb-2">Peso</label>
                            <input type="text" id="inp-peso" placeholder="Ex: 70kg, 154lbs..." class="custom-input data-field">
                        </div>
                        
                        <div>
                            <label class="block text-xs uppercase tracking-widest text-[#606060] font-cinzel mb-2">Ra√ßa</label>
                            <input type="text" id="inp-raca" placeholder="Ex: Humano, Elfo, An√£o..." class="custom-input data-field">
                        </div>
                        
                        <div>
                            <label class="block text-xs uppercase tracking-widest text-[#606060] font-cinzel mb-2">
                                Classe
                                <span class="text-[#10b981] text-xs font-normal normal-case">(Escolha livre ou pegue de uma classe pronta)</span>
                            </label>
                            <div class="flex gap-2">
                                <input type="text" id="inp-classe" placeholder="Ex: Guerreiro, Mago, Ladino..." class="custom-input data-field flex-1">
                                <a href="classe.html" class="flex items-center gap-1 px-3 py-2 text-xs bg-[#10b981]/10 text-[#10b981] border border-[#10b981]/20 rounded hover:bg-[#10b981]/20 transition-colors">
                                    <i data-lucide="swords" class="w-3 h-3"></i>
                                    Ver Classes
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SE√á√ÉO 2: APAR√äNCIA F√çSICA -->
        <section class="bg-theme-panel border border-theme-border p-6 rounded-lg anim-entry delay-2 card-highlight">
            <h3 class="flex items-center gap-2 font-cinzel text-lg font-semibold text-theme-orange mb-6">
                <i data-lucide="palette" class="w-5 h-5"></i> 
                <span>Apar√™ncia F√≠sica</span>
            </h3>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-[#606060] font-cinzel mb-2">Cabe√ßa / Rosto</label>
                        <textarea id="inp-cabeca" class="custom-textarea orange h-32 data-field" placeholder="Formato do rosto, cabelo, olhos, express√£o..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-[#606060] font-cinzel mb-2">Torso</label>
                        <textarea id="inp-torso" class="custom-textarea orange h-32 data-field" placeholder="Constitui√ß√£o f√≠sica, ombros, peito..."></textarea>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-[#606060] font-cinzel mb-2">Bra√ßos / M√£os</label>
                        <textarea id="inp-bracos" class="custom-textarea orange h-32 data-field" placeholder="For√ßa aparente, cicatrizes, tatuagens..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-[#606060] font-cinzel mb-2">Pernas / P√©s</label>
                        <textarea id="inp-pernas" class="custom-textarea orange h-32 data-field" placeholder="Postura, marcha, cal√ßados..."></textarea>
                    </div>
                </div>
            </div>
        </section>

        <!-- SE√á√ÉO 3: HIST√ìRIA -->
        <section class="bg-[#0f120f] border border-[#1a3d1a] p-6 rounded-lg anim-entry delay-2 card-highlight">
            <h3 class="flex items-center gap-2 font-cinzel text-lg font-semibold text-[#32cd32] mb-6">
                <i data-lucide="book-open" class="w-5 h-5"></i> 
                <span>Hist√≥ria & Passado</span>
            </h3>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs uppercase tracking-widest text-[#82ff82] font-cinzel mb-2">Hist√≥ria de Fundo</label>
                    <textarea id="inp-historia" class="custom-textarea min-h-[200px] data-field border border-[#2a5f2a]" placeholder="Conte sua hist√≥ria desde o in√≠cio..."></textarea>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-[#82ff82] font-cinzel mb-2">Motiva√ß√µes</label>
                        <textarea id="inp-motivacoes" class="custom-textarea h-32 data-field border border-[#2a5f2a]" placeholder="O que o move? O que deseja alcan√ßar?"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-[#82ff82] font-cinzel mb-2">Medos / Traumas</label>
                        <textarea id="inp-medos" class="custom-textarea h-32 data-field border border-[#2a5f2a]" placeholder="O que teme? Que traumas carrega?"></textarea>
                    </div>
                </div>
            </div>
        </section>

        <!-- SE√á√ÉO 4: PERSONALIDADE -->
        <section class="bg-[#141307] border border-[#4d4300] p-6 rounded-lg anim-entry delay-3 card-highlight">
            <h3 class="flex items-center gap-2 font-cinzel text-lg font-semibold text-[#ffd700] mb-6">
                <i data-lucide="heart" class="w-5 h-5"></i> 
                <span>Personalidade & Comportamento</span>
            </h3>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-[#c8ad32] font-cinzel mb-2">Tra√ßos de Personalidade</label>
                        <textarea id="inp-personalidade" class="custom-textarea h-32 data-field border border-[#7a6a00]" placeholder="Como age normalmente? Como reage ao estresse?"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-[#c8ad32] font-cinzel mb-2">Ideais & Valores</label>
                        <textarea id="inp-ideais" class="custom-textarea h-32 data-field border border-[#7a6a00]" placeholder="Em que acredita? Que princ√≠pios segue?"></textarea>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-[#c8ad32] font-cinzel mb-2">Defeitos & Fraquezas</label>
                        <textarea id="inp-defeitos" class="custom-textarea h-32 data-field border border-[#7a6a00]" placeholder="V√≠cios, orgulho excessivo, medos irracionais..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-[#c8ad32] font-cinzel mb-2">Maneirismos & H√°bitos</label>
                        <textarea id="inp-habitos" class="custom-textarea h-32 data-field border border-[#7a6a00]" placeholder="Tiques, frases repetidas, costumes..."></textarea>
                    </div>
                </div>
            </div>
        </section>

        <!-- SE√á√ÉO 5: RELA√á√ïES -->
        <section class="bg-[#120f1a] border border-[#3d1a3d] p-6 rounded-lg anim-entry delay-3 card-highlight">
            <h3 class="flex items-center gap-2 font-cinzel text-lg font-semibold text-[#d32cd3] mb-6">
                <i data-lucide="users" class="w-5 h-5"></i> 
                <span>Rela√ß√µes & Conex√µes</span>
            </h3>

            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-xs uppercase tracking-widest text-[#d082ff] font-cinzel mb-2">Aliados & Amigos</label>
                    <textarea id="inp-aliados" class="custom-textarea h-40 data-field border border-[#5f2a5f]" placeholder="Quem s√£o seus companheiros? Quem confia?"></textarea>
                </div>
                
                <div>
                    <label class="block text-xs uppercase tracking-widest text-[#d082ff] font-cinzel mb-2">Inimigos & Rivalidades</label>
                    <textarea id="inp-inimigos" class="custom-textarea h-40 data-field border border-[#5f2a5f]" placeholder="Quem o odeia? Com quem tem conflitos?"></textarea>
                </div>
            </div>
        </section>

        <!-- BOT√ïES DE A√á√ÉO INFERIORES -->
        <div class="fixed bottom-0 left-0 right-0 bg-gradient-to-t from-[#0a0a0c] via-[#0a0a0c]/95 to-transparent pt-8 pb-4 z-40">
            <div class="max-w-6xl mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="text-sm text-[#606060]">
                        <i data-lucide="info" class="w-4 h-4 inline mr-2"></i>
                        <span>Todos os dados s√£o salvos automaticamente no perfil ativo</span>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="limparFicha()" class="flex items-center gap-2 px-5 py-2.5 border border-theme-border rounded-lg text-theme-text hover:bg-white/5 transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            Limpar
                        </button>
                        
                        <button onclick="exportarTXT()" class="flex items-center gap-2 px-5 py-2.5 border border-theme-border rounded-lg text-theme-text hover:bg-white/5 transition-colors">
                            <i data-lucide="file-text" class="w-4 h-4"></i>
                            Exportar TXT
                        </button>
                        
                        <button onclick="salvarEAplicar()" class="flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-theme-blue to-cyan-600 rounded-lg text-white font-medium hover:opacity-90 transition-all active:scale-95">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            Salvar e Aplicar
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- FEEDBACK FLUTUANTE -->
    <div id="feedback-toast" class="fixed top-4 right-4 z-50 hidden">
        <div class="feedback-success px-4 py-3 rounded-lg shadow-lg border min-w-[300px]">
            <div class="flex items-center gap-3">
                <div id="feedback-icon"></div>
                <div>
                    <div id="feedback-title" class="font-medium"></div>
                    <div id="feedback-message" class="text-sm opacity-80"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. INICIALIZA√á√ÉO
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            inicializarFicha();
            configurarAutoSave();
        });

        // 2. VARI√ÅVEIS GLOBAIS
        let currentAvatar = null;
        let autoSaveTimer = null;
        let hasUnsavedChanges = false;

        // 3. SISTEMA DE PERFIS
        function inicializarFicha() {
            // Verificar se h√° perfil ativo
            const perfilAtivo = getActiveProfile();
            
            if (!perfilAtivo) {
                showFeedback('‚ö†Ô∏è Nenhum perfil ativo!', 'Voc√™ ser√° redirecionado para criar um perfil.', 'warning');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
                return;
            }
            
            // Atualizar informa√ß√£o do perfil
            atualizarInfoPerfil(perfilAtivo);
            
            // Carregar dados da ficha se existirem
            if (perfilAtivo.ficha) {
                carregarDadosFicha(perfilAtivo.ficha);
            }
            
            // Verificar classe pr√©-definida
            if (perfilAtivo.classe && perfilAtivo.classe !== 'Escolha livre') {
                document.getElementById('inp-classe').value = perfilAtivo.classe;
                showFeedback('üìã Classe carregada', `Classe "${perfilAtivo.classe}" aplicada da p√°gina de classes.`, 'info');
            }
        }

        function atualizarInfoPerfil(perfil) {
            document.getElementById('profile-name').textContent = perfil.nome || 'Novo Personagem';
            
            if (perfil.ultimaAtualizacao) {
                const data = new Date(perfil.ultimaAtualizacao);
                const agora = new Date();
                const diffMs = agora - data;
                const diffMin = Math.floor(diffMs / (1000 * 60));
                
                let texto = '';
                if (diffMin < 1) {
                    texto = 'Atualizado agora';
                } else if (diffMin < 60) {
                    texto = `Atualizado h√° ${diffMin} min`;
                } else if (diffMin < 1440) {
                    texto = `Atualizado hoje √†s ${data.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}`;
                } else {
                    texto = `Atualizado em ${data.toLocaleDateString('pt-BR')}`;
                }
                
                document.getElementById('profile-last-update').textContent = texto;
            }
        }

        // 4. FUN√á√ÉO PRINCIPAL DE SALVAMENTO
        function salvarEAplicar() {
            const perfilAtivo = getActiveProfile();
            
            if (!perfilAtivo) {
                showFeedback('‚ùå Erro', 'Nenhum perfil ativo encontrado!', 'error');
                return;
            }
            
            // Coletar todos os dados
            const dadosFicha = coletarTodosDados();
            
            // Validar campos obrigat√≥rios
            if (!dadosFicha.nome || dadosFicha.nome.trim() === '') {
                showFeedback('‚ö†Ô∏è Aten√ß√£o', 'O nome do personagem √© obrigat√≥rio!', 'warning');
                document.getElementById('inp-nome').focus();
                return;
            }
            
            // Atualizar perfil ativo
            perfilAtivo.ficha = dadosFicha;
            
            // Atualizar informa√ß√µes b√°sicas para o Hub
            perfilAtivo.nome = dadosFicha.nome;
            perfilAtivo.titulo = dadosFicha.titulo || '';
            perfilAtivo.classe = dadosFicha.classe || 'Escolha livre';
            perfilAtivo.raca = dadosFicha.raca || '';
            perfilAtivo.nivel = dadosFicha.nivel || 1;
            perfilAtivo.avatar = currentAvatar || perfilAtivo.avatar;
            perfilAtivo.ultimaAtualizacao = new Date().toISOString();
            
            // Salvar no localStorage
            localStorage.setItem('grimorio_perfil_ativo', JSON.stringify(perfilAtivo));
            
            // Marcar como salvo
            hasUnsavedChanges = false;
            
            // Feedback
            showFeedback('‚úÖ Sucesso!', 'Ficha salva no perfil ativo!', 'success');
            
            // Atualizar display
            atualizarInfoPerfil(perfilAtivo);
            
            // For√ßar atualiza√ß√£o do Hub
            if (window.parent && window.parent.carregarPerfilAtivo) {
                window.parent.carregarPerfilAtivo();
            }
        }

        function coletarTodosDados() {
            return {
                // Identidade
                nome: document.getElementById('inp-nome').value,
                titulo: document.getElementById('inp-titulo').value,
                nivel: parseInt(document.getElementById('inp-nivel').value) || 1,
                idade: document.getElementById('inp-idade').value,
                altura: document.getElementById('inp-altura').value,
                peso: document.getElementById('inp-peso').value,
                raca: document.getElementById('inp-raca').value,
                classe: document.getElementById('inp-classe').value,
                
                // Apar√™ncia
                cabeca: document.getElementById('inp-cabeca').value,
                torso: document.getElementById('inp-torso').value,
                bracos: document.getElementById('inp-bracos').value,
                pernas: document.getElementById('inp-pernas').value,
                
                // Hist√≥ria
                historia: document.getElementById('inp-historia').value,
                motivacoes: document.getElementById('inp-motivacoes').value,
                medos: document.getElementById('inp-medos').value,
                
                // Personalidade
                personalidade: document.getElementById('inp-personalidade').value,
                ideais: document.getElementById('inp-ideais').value,
                defeitos: document.getElementById('inp-defeitos').value,
                habitos: document.getElementById('inp-habitos').value,
                
                // Rela√ß√µes
                aliados: document.getElementById('inp-aliados').value,
                inimigos: document.getElementById('inp-inimigos').value,
                
                // Metadados
                dataSalvamento: new Date().toISOString(),
                versao: '1.0'
            };
        }

        function carregarDadosFicha(dados) {
            // Identidade
            if (dados.nome) document.getElementById('inp-nome').value = dados.nome;
            if (dados.titulo) document.getElementById('inp-titulo').value = dados.titulo;
            if (dados.nivel) document.getElementById('inp-nivel').value = dados.nivel;
            if (dados.idade) document.getElementById('inp-idade').value = dados.idade;
            if (dados.altura) document.getElementById('inp-altura').value = dados.altura;
            if (dados.peso) document.getElementById('inp-peso').value = dados.peso;
            if (dados.raca) document.getElementById('inp-raca').value = dados.raca;
            if (dados.classe) document.getElementById('inp-classe').value = dados.classe;
            
            // Apar√™ncia
            if (dados.cabeca) document.getElementById('inp-cabeca').value = dados.cabeca;
            if (dados.torso) document.getElementById('inp-torso').value = dados.torso;
            if (dados.bracos) document.getElementById('inp-bracos').value = dados.bracos;
            if (dados.pernas) document.getElementById('inp-pernas').value = dados.pernas;
            
            // Hist√≥ria
            if (dados.historia) document.getElementById('inp-historia').value = dados.historia;
            if (dados.motivacoes) document.getElementById('inp-motivacoes').value = dados.motivacoes;
            if (dados.medos) document.getElementById('inp-medos').value = dados.medos;
            
            // Personalidade
            if (dados.personalidade) document.getElementById('inp-personalidade').value = dados.personalidade;
            if (dados.ideais) document.getElementById('inp-ideais').value = dados.ideais;
            if (dados.defeitos) document.getElementById('inp-defeitos').value = dados.defeitos;
            if (dados.habitos) document.getElementById('inp-habitos').value = dados.habitos;
            
            // Rela√ß√µes
            if (dados.aliados) document.getElementById('inp-aliados').value = dados.aliados;
            if (dados.inimigos) document.getElementById('inp-inimigos').value = dados.inimigos;
            
            // Avatar
            if (dados.avatar) {
                currentAvatar = dados.avatar;
                const container = document.getElementById('avatar-container');
                container.style.backgroundImage = `url('${dados.avatar}')`;
                container.querySelector('.avatar-placeholder').style.opacity = '0';
            }
        }

        // 5. SISTEMA DE AVATAR
        function previewImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validar tipo e tamanho
            if (!file.type.match('image.*')) {
                showFeedback('‚ùå Erro', 'Por favor, selecione uma imagem v√°lida.', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showFeedback('‚ö†Ô∏è Tamanho excessivo', 'A imagem deve ter menos de 5MB.', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                // Comprimir imagem
                comprimirImagem(e.target.result, 400, function(imagemComprimida) {
                    currentAvatar = imagemComprimida;
                    
                    // Aplicar ao container
                    const container = document.getElementById('avatar-container');
                    container.style.backgroundImage = `url('${imagemComprimida}')`;
                    container.querySelector('.avatar-placeholder').style.opacity = '0';
                    
                    // Marcar como n√£o salvo
                    hasUnsavedChanges = true;
                    
                    showFeedback('üì∑ Avatar carregado', 'Clique em "Salvar e Aplicar" para gravar.', 'info');
                });
            };
            reader.readAsDataURL(file);
        }

        function comprimirImagem(base64, tamanhoMax, callback) {
            const img = new Image();
            img.src = base64;
            
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // Redimensionar mantendo propor√ß√£o
                if (width > height) {
                    if (width > tamanhoMax) {
                        height = Math.round((height * tamanhoMax) / width);
                        width = tamanhoMax;
                    }
                } else {
                    if (height > tamanhoMax) {
                        width = Math.round((width * tamanhoMax) / height);
                        height = tamanhoMax;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // Converter para JPEG com 85% de qualidade
                const imagemComprimida = canvas.toDataURL('image/jpeg', 0.85);
                callback(imagemComprimida);
            };
        }

        function removerAvatar() {
            currentAvatar = null;
            const container = document.getElementById('avatar-container');
            container.style.backgroundImage = '';
            container.querySelector('.avatar-placeholder').style.opacity = '1';
            
            hasUnsavedChanges = true;
            showFeedback('üóëÔ∏è Avatar removido', 'Clique em "Salvar e Aplicar" para atualizar.', 'info');
        }

        // 6. FUN√á√ïES AUXILIARES
        function getActiveProfile() {
            const dados = localStorage.getItem('grimorio_perfil_ativo');
            return dados ? JSON.parse(dados) : null;
        }

        function configurarAutoSave() {
            // Configurar salvamento autom√°tico ap√≥s 30 segundos de inatividade
            const campos = document.querySelectorAll('.data-field');
            
            campos.forEach(campo => {
                campo.addEventListener('input', function() {
                    hasUnsavedChanges = true;
                    
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(function() {
                        if (hasUnsavedChanges && confirm('Salvar altera√ß√µes automaticamente?')) {
                            salvarEAplicar();
                        }
                    }, 30000); // 30 segundos
                });
            });
            
            // Alertar antes de sair se houver altera√ß√µes n√£o salvas
            window.addEventListener('beforeunload', function(e) {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = 'Voc√™ tem altera√ß√µes n√£o salvas. Deseja realmente sair?';
                }
            });
        }

        function showFeedback(titulo, mensagem, tipo = 'info') {
            const toast = document.getElementById('feedback-toast');
            const icon = document.getElementById('feedback-icon');
            const titleEl = document.getElementById('feedback-title');
            const messageEl = document.getElementById('feedback-message');
            
            // Configurar cores
            let corBg, corBorda, corTexto, icone;
            
            switch(tipo) {
                case 'success':
                    corBg = 'bg-green-900/20';
                    corBorda = 'border-green-700';
                    corTexto = 'text-green-300';
                    icone = 'check-circle';
                    break;
                case 'error':
                    corBg = 'bg-red-900/20';
                    corBorda = 'border-red-700';
                    corTexto = 'text-red-300';
                    icone = 'alert-circle';
                    break;
                case 'warning':
                    corBg = 'bg-yellow-900/20';
                    corBorda = 'border-yellow-700';
                    corTexto = 'text-yellow-300';
                    icone = 'alert-triangle';
                    break;
                default:
                    corBg = 'bg-blue-900/20';
                    corBorda = 'border-blue-700';
                    corTexto = 'text-blue-300';
                    icone = 'info';
            }
            
            // Atualizar conte√∫do
            icon.innerHTML = `<i data-lucide="${icone}" class="w-5 h-5"></i>`;
            titleEl.textContent = titulo;
            messageEl.textContent = mensagem;
            
            // Atualizar classes
            toast.className = `fixed top-4 right-4 z-50 feedback-success ${corBg} ${corBorda} ${corTexto}`;
            
            // Mostrar
            toast.classList.remove('hidden');
            
            // Recriar √≠cones
            lucide.createIcons();
            
            // Esconder ap√≥s 5 segundos
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 5000);
        }

        // 7. FUN√á√ïES DE UTILIDADE
        function limparFicha() {
            if (!confirm('Tem certeza que deseja limpar toda a ficha? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            const campos = document.querySelectorAll('.data-field');
            campos.forEach(campo => {
                if (campo.type === 'number') {
                    campo.value = campo.id === 'inp-nivel' ? '1' : '';
                } else {
                    campo.value = '';
                }
            });
            
            removerAvatar();
            hasUnsavedChanges = true;
            
            showFeedback('üßπ Ficha limpa', 'Todos os campos foram resetados.', 'info');
        }

        function exportarTXT() {
            const dados = coletarTodosDados();
            let texto = '';
            
            texto += '='.repeat(50) + '\n';
            texto += 'FICHA DE PERSONAGEM - GRIM√ìRIO DIGITAL\n';
            texto += '='.repeat(50) + '\n\n';
            
            // Identidade
            texto += 'IDENTIDADE\n';
            texto += '-'.repeat(50) + '\n';
            texto += `Nome: ${dados.nome || 'N√£o definido'}\n`;
            texto += `T√≠tulo: ${dados.titulo || 'N√£o definido'}\n`;
            texto += `N√≠vel: ${dados.nivel || '1'}\n`;
            texto += `Idade: ${dados.idade || 'N√£o definida'}\n`;
            texto += `Altura: ${dados.altura || 'N√£o definida'}\n`;
            texto += `Peso: ${dados.peso || 'N√£o definido'}\n`;
            texto += `Ra√ßa: ${dados.raca || 'N√£o definida'}\n`;
            texto += `Classe: ${dados.classe || 'Escolha livre'}\n\n`;
            
            // Apar√™ncia
            texto += 'APAR√äNCIA F√çSICA\n';
            texto += '-'.repeat(50) + '\n';
            texto += `Cabe√ßa/Rosto: ${dados.cabeca || 'N√£o descrito'}\n\n`;
            texto += `Torso: ${dados.torso || 'N√£o descrito'}\n\n`;
            texto += `Bra√ßos/M√£os: ${dados.bracos || 'N√£o descrito'}\n\n`;
            texto += `Pernas/P√©s: ${dados.pernas || 'N√£o descrito'}\n\n`;
            
            // Hist√≥ria
            texto += 'HIST√ìRIA & PASSADO\n';
            texto += '-'.repeat(50) + '\n';
            texto += `Hist√≥ria de Fundo: ${dados.historia || 'N√£o escrita'}\n\n`;
            texto += `Motiva√ß√µes: ${dados.motivacoes || 'N√£o definidas'}\n\n`;
            texto += `Medos/Traumas: ${dados.medos || 'N√£o definidos'}\n\n`;
            
            // Personalidade
            texto += 'PERSONALIDADE\n';
            texto += '-'.repeat(50) + '\n';
            texto += `Tra√ßos de Personalidade: ${dados.personalidade || 'N√£o definidos'}\n\n`;
            texto += `Ideais & Valores: ${dados.ideais || 'N√£o definidos'}\n\n`;
            texto += `Defeitos & Fraquezas: ${dados.defeitos || 'N√£o definidos'}\n\n`;
            texto += `Maneirismos & H√°bitos: ${dados.habitos || 'N√£o definidos'}\n\n`;
            
            // Rela√ß√µes
            texto += 'RELA√á√ïES\n';
            texto += '-'.repeat(50) + '\n';
            texto += `Aliados & Amigos: ${dados.aliados || 'N√£o definidos'}\n\n`;
            texto += `Inimigos & Rivalidades: ${dados.inimigos || 'N√£o definidos'}\n\n`;
            
            texto += '='.repeat(50) + '\n';
            texto += `Exportado em: ${new Date().toLocaleString('pt-BR')}\n`;
            texto += '='.repeat(50) + '\n';
            
            // Criar arquivo
            const blob = new Blob([texto], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            const nomeArquivo = `ficha_${(dados.nome || 'personagem').toLowerCase().replace(/\s+/g, '_')}.txt`;
            
            link.href = URL.createObjectURL(blob);
            link.download = nomeArquivo;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showFeedback('üìÑ Exportado!', 'Ficha salva como arquivo TXT.', 'success');
        }

        // 8. EXPORTAR FUN√á√ïES PARA O GLOBAL
        window.salvarEAplicar = salvarEAplicar;
        window.limparFicha = limparFicha;
        window.exportarTXT = exportarTXT;
        window.previewImage = previewImage;
        window.removerAvatar = removerAvatar;

        // 9. FUN√á√ÉO ESPECIAL PARA P√ÅGINA DE CLASSES USAR
        window.aplicarClasse = function(dadosClasse) {
            if (dadosClasse.nome) {
                document.getElementById('inp-classe').value = dadosClasse.nome;
                showFeedback('üéØ Classe aplicada!', `Classe "${dadosClasse.nome}" foi adicionada √† ficha.`, 'success');
                
                // Salvar automaticamente se houver perfil ativo
                const perfil = getActiveProfile();
                if (perfil) {
                    perfil.classe = dadosClasse.nome;
                    localStorage.setItem('grimorio_perfil_ativo', JSON.stringify(perfil));
                }
            }
        };
        // No ficha.html, adicione esta fun√ß√£o para salvar no perfil
        function saveAllToProfile() {
            try {
                // Coletar todos os dados da ficha
                const dadosFicha = coletarDadosDaFicha(); // Sua fun√ß√£o existente
                
                // Carregar perfil ativo
                const perfis = localStorage.getItem('rpg_sistema_perfis');
                const perfilAtivoId = localStorage.getItem('perfil_ativo');
                
                if (!perfis || !perfilAtivoId) {
                    console.error('Nenhum perfil ativo encontrado');
                    return false;
                }
                
                const perfisObj = JSON.parse(perfis);
                const perfilAtivo = perfisObj[perfilAtivoId];
                
                if (!perfilAtivo) {
                    console.error('Perfil ativo n√£o encontrado');
                    return false;
                }
                
                // Estrutura completa dos dados
                const dadosCompletos = {
                    // Dados b√°sicos
                    basico: {
                        nome: document.getElementById('input-nome')?.value || 'Personagem',
                        raca: document.getElementById('raca-select')?.value || '',
                        classe: document.getElementById('classe-select')?.value || '',
                        origem: document.getElementById('input-origem')?.value || '',
                        idade: document.getElementById('input-idade')?.value || '',
                        altura: document.getElementById('input-altura')?.value || '',
                        peso: document.getElementById('input-peso')?.value || '',
                        alinhamento: document.getElementById('alinhamento-select')?.value || ''
                    },
                    
                    // Atributos (do status.html)
                    atributos: {
                        forca: document.getElementById('attr-forca')?.value || 0,
                        destreza: document.getElementById('attr-destreza')?.value || 0,
                        constituicao: document.getElementById('attr-constituicao')?.value || 0,
                        inteligencia: document.getElementById('attr-inteligencia')?.value || 0,
                        sabedoria: document.getElementById('attr-sabedoria')?.value || 0,
                        carisma: document.getElementById('attr-carisma')?.value || 0
                    },
                    
                    // Recursos (do status.html)
                    recursos: {
                        vida_atual: document.getElementById('input-vida-atual')?.value || 0,
                        vida_max: document.getElementById('input-vida-max')?.value || 0,
                        vida_base: 100, // Pode calcular baseado em atributos
                        mana_atual: document.getElementById('input-mana-atual')?.value || 0,
                        mana_max: document.getElementById('input-mana-max')?.value || 0,
                        mana_base: 50,
                        estamina_atual: document.getElementById('input-estamina-atual')?.value || 0,
                        estamina_max: document.getElementById('input-estamina-max')?.value || 0,
                        estamina_base: 80
                    },
                    
                    // Progress√£o (do status.html)
                    progressao: {
                        nivel: document.getElementById('input-nivel')?.value || 1,
                        xp_atual: document.getElementById('input-xp-acumulado')?.value || 0,
                        xp_proximo: 1000
                    },
                    
                    // Destino (do status.html)
                    destino: JSON.parse(localStorage.getItem('grimorio_sorte')) || {
                        valor: null,
                        dados: [0, 0, 0],
                        fixada: false
                    },
                    
                    // Dados da ficha completa
                    ficha: dadosFicha
                };
                
                // Salvar no perfil
                perfilAtivo.dados = dadosCompletos;
                perfisObj[perfilAtivoId] = perfilAtivo;
                localStorage.setItem('rpg_sistema_perfis', JSON.stringify(perfisObj));
                
                // Salvar tamb√©m localmente (backup)
                localStorage.setItem('grimorio_perfil_completo', JSON.stringify(dadosCompletos));
                
                console.log('Dados salvos no perfil:', perfilAtivoId);
                return true;
                
            } catch (error) {
                console.error('Erro ao salvar no perfil:', error);
                return false;
            }
        }

        // Chame esta fun√ß√£o sempre que salvar na ficha
        function saveFicha() {
            // ... seu c√≥digo atual de salvar ...
            
            // Depois de salvar localmente, salvar no perfil
            saveAllToProfile();
            
            mostrarFeedback("Ficha salva no perfil!", "success");
        }
        // shared.js - Coloque em todas as p√°ginas
        class GrimorioSaveSystem {
            static saveCharacter(data) {
                localStorage.setItem('grimorio_character_data', JSON.stringify(data));
                this.notifyUpdate('character');
            }
            
            static saveMascot(data) {
                localStorage.setItem('grimorio_mascot_data', JSON.stringify(data));
                this.notifyUpdate('mascot');
            }
            
            static saveItems(data) {
                localStorage.setItem('grimorio_items_data', JSON.stringify(data));
                this.notifyUpdate('items');
            }
            
            static loadCharacter() {
                const data = localStorage.getItem('grimorio_character_data');
                return data ? JSON.parse(data) : null;
            }
            
            static loadMascot() {
                const data = localStorage.getItem('grimorio_mascot_data');
                return data ? JSON.parse(data) : null;
            }
            
            static loadItems() {
                const data = localStorage.getItem('grimorio_items_data');
                return data ? JSON.parse(data) : [];
            }
            
            static notifyUpdate(type) {
                // Dispara evento customizado
                const event = new CustomEvent('grimorio-update', {
                    detail: { type: type, timestamp: Date.now() }
                });
                window.dispatchEvent(event);
            }
            
            static exportAll() {
                const allData = {
                    character: this.loadCharacter(),
                    mascot: this.loadMascot(),
                    items: this.loadItems(),
                    version: '2.0',
                    exportDate: new Date().toISOString()
                };
                
                return JSON.stringify(allData, null, 2);
            }
            
            static importAll(jsonString) {
                try {
                    const data = JSON.parse(jsonString);
                    
                    if (data.character) {
                        this.saveCharacter(data.character);
                    }
                    if (data.mascot) {
                        this.saveMascot(data.mascot);
                    }
                    if (data.items) {
                        this.saveItems(data.items);
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Erro ao importar:', error);
                    return false;
                }
            }
        }

        // Listener para atualiza√ß√µes em tempo real
        window.addEventListener('grimorio-update', function(event) {
            console.log('Dados atualizados:', event.detail.type);
            // Atualiza a p√°gina atual com os novos dados
            refreshCurrentPage();
        });

        // Fun√ß√£o para detectar mudan√ßas no localStorage de outras abas
        window.addEventListener('storage', function(event) {
            if (event.key.startsWith('grimorio_')) {
                location.reload(); // Recarrega para mostrar dados atualizados
            }
        });
    </script>
</body>
</html>