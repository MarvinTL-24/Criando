<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grimório Digital - Perfil do Personagem</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="js/grimorio-core.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        cinzel: ['Cinzel', 'serif'],
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        theme: {
                            bg: '#0a0a0c',
                            panel: '#0f0f12',
                            border: '#2a2a2e',
                            text: '#e8e4dc',
                            blue: '#4a9eff',
                            orange: '#ff6b35',
                            red: '#dc2626',
                            green: '#22c55e',
                            purple: '#8b5cf6',
                            yellow: '#f59e0b',
                            pink: '#ec4899',
                            gold: '#d4a76a',
                            copper: '#8b7355'
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.6s ease-out forwards',
                        'slide-in-right': 'slideInRight 0.3s ease-out',
                        'pulse': 'pulse 2s infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            'from': { opacity: '0', transform: 'translateY(20px)' },
                            'to': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideInRight: {
                            'from': { transform: 'translateX(100%)', opacity: '0' },
                            'to': { transform: 'translateX(0)', opacity: '1' }
                        },
                        pulse: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.5' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0a0a0c; color: #e8e4dc; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0c; }
        ::-webkit-scrollbar-thumb { background: #2a2a2e; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4a9eff; }

        .anim-delay-0 { animation-delay: 0s; }
        .anim-delay-1 { animation-delay: 0.1s; }
        .anim-delay-2 { animation-delay: 0.2s; }
        .anim-delay-3 { animation-delay: 0.3s; }
        .anim-delay-4 { animation-delay: 0.4s; }

        .stat-bar-fill { 
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        
        .character-card {
            background: linear-gradient(145deg, #1a1510, #2a2318);
            border: 2px solid #8b7355;
            transition: all 0.3s ease;
        }
        
        .character-card:hover {
            border-color: #d4a76a;
            box-shadow: 0 8px 32px rgba(139, 115, 85, 0.2);
        }

        .bg-destiny-1 { background-color: #1a1510; }
        .bg-destiny-2 { background-color: #2a2318; }
        .border-destiny { border-color: #8b7355; }
        .text-destiny-gold { color: #d4a76a; }
        .text-destiny-light { color: #f4d29a; }
        .text-destiny-dark { color: #8b7355; }

        .profile-active-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #22c55e;
            box-shadow: 0 0 10px #22c55e;
            animation: pulse 2s infinite;
        }

        .level-badge {
            background: linear-gradient(45deg, #8b7355, #d4a76a);
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 4px 12px rgba(212, 167, 106, 0.2);
        }

        .avatar-container {
            background: linear-gradient(135deg, #2a2a2e 0%, #1a1a1e 100%);
            border: 2px solid #8b7355;
            transition: all 0.3s ease;
        }
        
        .avatar-container:hover {
            border-color: #d4a76a;
            transform: scale(1.02);
        }

        .item-slot {
            background: #0a0a0c;
            border: 2px dashed #2a2a2e;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 150px;
            position: relative;
        }
        
        .item-slot:hover {
            border-color: #4a9eff;
            background: #0f0f12;
        }
        
        .item-slot.filled {
            border-style: solid;
            border-color: #8b7355;
        }
        
        .quick-item {
            width: 60px;
            height: 60px;
            border: 2px solid #2a2a2e;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0a0a0c;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .quick-item:hover {
            border-color: #d4a76a;
            transform: scale(1.05);
        }
        
        .quick-item img {
            max-width: 80%;
            max-height: 80%;
            object-fit: contain;
        }

        .skill-progress {
            height: 4px;
            background: #2a2a2e;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .skill-progress-fill {
            height: 100%;
            transition: width 0.5s ease;
        }

        .upload-btn {
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .upload-btn input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .maestria-badge {
            background: linear-gradient(45deg, #f59e0b, #d97706);
            color: white;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            animation: pulse 2s infinite;
        }

        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        
        /* Estilo para o modal de sorte */
        .sorte-emotion-btn {
            transition: all 0.3s ease;
        }
        
        .sorte-emotion-btn.selected {
            transform: scale(1.05);
            box-shadow: 0 0 0 2px currentColor;
        }
        
        .sorte-result {
            font-size: 4rem;
            font-weight: bold;
            text-shadow: 0 0 20px currentColor;
        }
        
        .sorte-success {
            color: #22c55e;
            animation: pulse 1s infinite;
        }
        
        .sorte-failure {
            color: #dc2626;
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body class="min-h-screen font-sans pb-20">

    <!-- Navbar -->
    <nav class="w-full bg-[#0f0f12]/95 backdrop-blur-sm border-b border-theme-border sticky top-0 z-50 mb-8">
        <div class="max-w-7xl mx-auto px-4 flex items-center justify-between py-4">
            <div class="flex items-center gap-4">
                <a href="index.html" class="text-theme-text hover:text-theme-blue transition-colors flex items-center gap-2">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    <span class="font-cinzel text-sm">Voltar ao Início</span>
                </a>
                <div class="h-6 w-[1px] bg-theme-border"></div>
                <span class="font-cinzel font-bold text-lg tracking-wide text-theme-orange">Perfil do Personagem</span>
            </div>
            
            <div class="flex items-center gap-3" id="nav-buttons">
                <button onclick="carregarStatus()" class="nav-btn bg-blue-500/20 text-blue-400">
                    <i data-lucide="activity" class="w-4 h-4"></i> Status
                </button>
                <button onclick="carregarEquipamentos()" class="nav-btn bg-green-500/20 text-green-400">
                    <i data-lucide="sword" class="w-4 h-4"></i> Equipamentos
                </button>
                <button onclick="carregarHabilidades()" class="nav-btn bg-purple-500/20 text-purple-400">
                    <i data-lucide="zap" class="w-4 h-4"></i> Habilidades
                </button>
            </div>
        </div>
        <div class="h-[1px] bg-gradient-to-r from-transparent via-theme-orange to-transparent"></div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 space-y-6" id="profile-content">

        <!-- Cabeçalho do Perfil -->
        <header class="flex flex-col md:flex-row items-start md:items-center justify-between mb-8 animate-fade-in-up">
            <div class="flex items-center gap-6 w-full md:w-auto">
                <!-- Avatar/Imagem -->
                <div id="avatar-display" class="avatar-container w-24 h-24 rounded-lg overflow-hidden flex items-center justify-center cursor-pointer" onclick="alterarAvatar()">
                    <i data-lucide="user" class="w-12 h-12 text-[#606060]" id="avatar-icon"></i>
                    <img id="avatar-image" class="hidden w-full h-full object-cover">
                </div>
                
                <div class="flex-grow">
                    <h1 id="profile-title" class="text-3xl font-cinzel font-bold text-white">Perfil do Personagem</h1>
                    <p id="profile-subtitle" class="text-gray-400">Status, Equipamentos e Habilidades</p>
                </div>
            </div>
            
            <div class="relative mt-4 md:mt-0">
                <div class="text-right">
                    <span class="text-xs uppercase text-gray-500">Última Atualização</span>
                    <div id="last-update" class="font-cinzel font-bold text-theme-gold">Carregando...</div>
                </div>
                <div id="profile-active-indicator" class="profile-active-indicator hidden"></div>
            </div>
        </header>

        <!-- Seção 1: Status Principal -->
        <section class="bg-theme-panel border border-theme-border p-6 rounded-lg animate-fade-in-up anim-delay-0">
            <div class="flex items-center gap-3 mb-6">
                <div class="p-2 rounded-lg bg-theme-red/10 border border-theme-red/20">
                    <i data-lucide="activity" class="w-4 h-4 text-theme-red"></i>
                </div>
                <h3 class="font-cinzel text-lg font-semibold text-white">Status Principal</h3>
                <div class="ml-auto flex gap-2">
                    <button onclick="editarStatus()" class="text-sm text-theme-blue hover:underline">
                        <i data-lucide="edit" class="w-3 h-3 inline mr-1"></i> Editar
                    </button>
                    <button onclick="calcularRecursos()" class="text-sm text-theme-green hover:underline">
                        <i data-lucide="calculator" class="w-3 h-3 inline mr-1"></i> Calcular Recursos
                    </button>
                    <button onclick="toggleDerivados()" class="text-sm text-theme-purple hover:underline">
                        <i data-lucide="eye" class="w-3 h-3 inline mr-1"></i> Ocultar Derivados
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- Vida -->
                <div class="bg-[#0a0a0c] border border-theme-border p-5 rounded-lg card-hover">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-full bg-theme-red/10">
                                <i data-lucide="heart" class="w-4 h-4 text-theme-red"></i>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-theme-red">Vida</span>
                                <div class="text-xs text-gray-500" id="vida-percent">100%</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="font-mono text-xl font-bold text-white" id="display-vida">100/100</span>
                            <div class="text-xs text-gray-500">HP</div>
                        </div>
                    </div>
                    <div class="h-3 bg-[#0a0a0c] rounded-full overflow-hidden mb-2">
                        <div id="display-vida-bar" class="h-full bg-gradient-to-r from-red-600 to-red-400 stat-bar-fill" style="width: 0%"></div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1" id="vida-formula">Base: 100 + (CON × 2)</div>
                </div>

                <!-- Mana -->
                <div class="bg-[#0a0a0c] border border-theme-border p-5 rounded-lg card-hover">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-full bg-theme-blue/10">
                                <i data-lucide="flame" class="w-4 h-4 text-theme-blue"></i>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-theme-blue">Mana</span>
                                <div class="text-xs text-gray-500" id="mana-percent">100%</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="font-mono text-xl font-bold text-white" id="display-mana">100/100</span>
                            <div class="text-xs text-gray-500">MP</div>
                        </div>
                    </div>
                    <div class="h-3 bg-[#0a0a0c] rounded-full overflow-hidden mb-2">
                        <div id="display-mana-bar" class="h-full bg-gradient-to-r from-blue-600 to-blue-400 stat-bar-fill" style="width: 0%"></div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1" id="mana-formula">Base: 50 + (INT × 3)</div>
                </div>

                <!-- Estamina -->
                <div class="bg-[#0a0a0c] border border-theme-border p-5 rounded-lg card-hover">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-full bg-theme-green/10">
                                <i data-lucide="wind" class="w-4 h-4 text-theme-green"></i>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-theme-green">Estamina</span>
                                <div class="text-xs text-gray-500" id="estamina-percent">100%</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="font-mono text-xl font-bold text-white" id="display-estamina">100/100</span>
                            <div class="text-xs text-gray-500">SP</div>
                        </div>
                    </div>
                    <div class="h-3 bg-[#0a0a0c] rounded-full overflow-hidden mb-2">
                        <div id="display-estamina-bar" class="h-full bg-gradient-to-r from-green-600 to-green-400 stat-bar-fill" style="width: 0%"></div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1" id="estamina-formula">Base: 80 + (DES + CON)</div>
                </div>
            </div>

            <!-- Atributos -->
            <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mt-6" id="atributos-container">
                <!-- Atributos serão carregados dinamicamente -->
            </div>
        </section>

        <!-- Seção 2: Classe e Pontos -->
        <section class="bg-destiny-1 border border-destiny p-6 rounded-lg animate-fade-in-up anim-delay-1">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-theme-purple/10 border border-theme-purple/20">
                        <i data-lucide="crown" class="w-4 h-4 text-theme-purple"></i>
                    </div>
                    <h3 class="font-cinzel text-lg font-semibold text-destiny-light">Classe & Pontos</h3>
                </div>
                <button onclick="editarClasse()" class="text-sm text-destiny-gold hover:underline">
                    <i data-lucide="edit-3" class="w-3 h-3 inline mr-1"></i> Alterar
                </button>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <!-- Informações da Classe -->
                <div class="bg-destiny-2 border border-destiny/50 p-6 rounded-xl">
                    <h4 class="font-cinzel font-bold text-destiny-light text-lg mb-4">Classe do Personagem</h4>
                    <div id="classe-info">
                        <div class="text-center py-4">
                            <i data-lucide="user-plus" class="w-12 h-12 mx-auto text-destiny-dark mb-3"></i>
                            <p class="text-destiny-dark">Nenhuma classe selecionada</p>
                        </div>
                    </div>
                </div>

                <!-- Pontos Extras -->
                <div class="bg-destiny-2 border border-destiny/50 p-6 rounded-xl">
                    <h4 class="font-cinzel font-bold text-destiny-light text-lg mb-4">Progressão</h4>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-destiny-light">Pontos Disponíveis</span>
                                <span class="text-2xl font-bold text-destiny-gold" id="pontos-disponiveis">0</span>
                            </div>
                            <div class="skill-progress">
                                <div id="pontos-progress" class="skill-progress-fill bg-gradient-to-r from-destiny-gold to-yellow-400" style="width: 0%"></div>
                            </div>
                            <div class="text-xs text-destiny-dark mt-1" id="pontos-nivel">+2 pontos por nível</div>
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-destiny-light">Nível</span>
                                <span class="text-xl font-bold text-destiny-gold" id="nivel-personagem">1</span>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button onclick="alterarNivel(-1)" class="flex-1 py-1 text-xs border border-destiny rounded hover:bg-destiny/20">-1</button>
                                <button onclick="alterarNivel(1)" class="flex-1 py-1 text-xs border border-destiny rounded hover:bg-destiny/20">+1</button>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-destiny-light">Experiência</span>
                                <span class="text-xl font-bold text-destiny-gold" id="experiencia-personagem">0/1000</span>
                            </div>
                            <div class="skill-progress">
                                <div id="exp-progress" class="skill-progress-fill bg-gradient-to-r from-blue-500 to-purple-500" style="width: 0%"></div>
                            </div>
                            <div class="flex items-center gap-2 mt-2">
                                <input type="number" id="add-exp-input" placeholder="XP" class="flex-1 bg-destiny-1 border border-destiny rounded px-2 py-1 text-xs">
                                <button onclick="adicionarExperiencia()" class="px-3 py-1 text-xs bg-destiny-gold/20 hover:bg-destiny-gold/30 border border-destiny-gold rounded">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Seção 3: Sorte e Destino -->
        <section class="bg-theme-panel border border-theme-border p-6 rounded-lg animate-fade-in-up anim-delay-2">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-theme-blue/10 border border-theme-blue/20">
                        <i data-lucide="clover" class="w-4 h-4 text-theme-blue"></i>
                    </div>
                    <h3 class="font-cinzel text-lg font-semibold text-white">Sorte & Destino</h3>
                </div>
                <div class="flex gap-2">
                    <button onclick="rolarSorteISP()" class="text-sm text-theme-green hover:underline">
                        <i data-lucide="dice-5" class="w-3 h-3 inline mr-1"></i> Rolar Sorte
                    </button>
                    <button onclick="editarSorte()" class="text-sm text-theme-blue hover:underline">
                        <i data-lucide="edit" class="w-3 h-3 inline mr-1"></i> Configurar
                    </button>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <!-- Índice de Sorte Percentual (ISP) -->
                <div class="bg-[#0a0a0c] border border-theme-border p-6 rounded-xl text-center card-hover">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-theme-purple to-theme-pink flex items-center justify-center shadow-lg animate-float">
                        <i data-lucide="sparkles" class="w-8 h-8 text-white"></i>
                    </div>
                    <h4 class="font-cinzel font-bold text-white text-lg mb-2">Índice de Sorte Percentual</h4>
                    <div class="text-5xl font-bold font-mono text-theme-gold mb-2" id="display-sorte-isp">--%</div>
                    <div class="h-2 bg-theme-border rounded-full overflow-hidden mb-3">
                        <div id="display-sorte-isp-bar" class="h-full bg-gradient-to-r from-theme-purple to-theme-pink stat-bar-fill" style="width: 0%"></div>
                    </div>
                    <div id="isp-status" class="text-sm text-gray-400">Status: Não Definido</div>
                    <div id="isp-resultado" class="mt-2 hidden"></div>
                </div>

                <!-- Configuração ISP -->
                <div class="bg-[#0a0a0c] border border-theme-border p-6 rounded-xl card-hover">
                    <h4 class="font-cinzel font-bold text-white text-lg mb-4">Configuração ISP</h4>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">PER (Percepção)</label>
                            <input type="number" id="isp-per" value="10" min="1" max="20" 
                                   class="w-full bg-theme-panel border border-theme-border rounded px-3 py-2 text-white text-center" 
                                   onchange="calcularISP()">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">SAB (Sabedoria)</label>
                            <input type="number" id="isp-sab" value="10" min="1" max="20" 
                                   class="w-full bg-theme-panel border border-theme-border rounded px-3 py-2 text-white text-center"
                                   onchange="calcularISP()">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">AGI (Agilidade)</label>
                            <input type="number" id="isp-agi" value="10" min="1" max="20" 
                                   class="w-full bg-theme-panel border border-theme-border rounded px-3 py-2 text-white text-center"
                                   onchange="calcularISP()">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">E (Emoção 1-5)</label>
                            <input type="number" id="isp-emocao" value="3" min="1" max="5" 
                                   class="w-full bg-theme-panel border border-theme-border rounded px-3 py-2 text-white text-center"
                                   onchange="calcularISP()">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-xs text-gray-400 mb-2">Estado Emocional</label>
                        <div class="grid grid-cols-5 gap-2" id="emocao-buttons">
                            <!-- Botões serão preenchidos dinamicamente -->
                        </div>
                    </div>
                    
                    <div class="text-sm text-gray-500" id="isp-formula-display">
                        Fórmula: ISP = ((PER + SAB + AGI) × E ÷ 3) + Modificador Emocional
                    </div>
                </div>
            </div>
        </section>

        <!-- Seção 4: Estatísticas Avançadas -->
        <section class="bg-theme-panel border border-theme-border p-6 rounded-lg animate-fade-in-up anim-delay-2" id="estatisticas-avancadas">
            <div class="flex items-center gap-3 mb-6">
                <div class="p-2 rounded-lg bg-theme-blue/10 border border-theme-blue/20">
                    <i data-lucide="bar-chart" class="w-4 h-4 text-theme-blue"></i>
                </div>
                <h3 class="font-cinzel text-lg font-semibold text-white">Estatísticas Derivadas</h3>
                <button onclick="toggleDerivados()" class="ml-auto text-sm text-theme-purple hover:underline">
                    <i data-lucide="eye" class="w-3 h-3 inline mr-1"></i> Ocultar
                </button>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <!-- Estatísticas serão carregadas dinamicamente -->
            </div>
        </section>

        <!-- Seção 5: Equipamentos -->
        <section class="bg-theme-panel border border-theme-border p-6 rounded-lg animate-fade-in-up anim-delay-3">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-theme-orange/10 border border-theme-orange/20">
                        <i data-lucide="sword" class="w-4 h-4 text-theme-orange"></i>
                    </div>
                    <h3 class="font-cinzel text-lg font-semibold text-white">Equipamentos</h3>
                </div>
                <div class="flex gap-2">
                    <button onclick="importarEquipamento()" class="text-sm text-theme-green hover:underline">
                        <i data-lucide="upload" class="w-3 h-3 inline mr-1"></i> Importar
                    </button>
                    <button onclick="editarEquipamentos()" class="text-sm text-theme-orange hover:underline">
                        <i data-lucide="edit" class="w-3 h-3 inline mr-1"></i> Gerenciar
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4" id="equipamentos-container">
                <!-- Slots serão preenchidos dinamicamente -->
            </div>
        </section>

        <!-- Seção 6: Habilidades -->
        <section class="bg-theme-panel border border-theme-border p-6 rounded-lg animate-fade-in-up anim-delay-3">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-theme-purple/10 border border-theme-purple/20">
                        <i data-lucide="zap" class="w-4 h-4 text-theme-purple"></i>
                    </div>
                    <h3 class="font-cinzel text-lg font-semibold text-white">Habilidades</h3>
                </div>
                <div class="flex gap-2">
                    <button onclick="criarHabilidade()" class="text-sm text-theme-green hover:underline">
                        <i data-lucide="plus" class="w-3 h-3 inline mr-1"></i> Criar
                    </button>
                    <button onclick="editarHabilidades()" class="text-sm text-theme-purple hover:underline">
                        <i data-lucide="edit" class="w-3 h-3 inline mr-1"></i> Gerenciar
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4" id="habilidades-container">
                <!-- Slots serão preenchidos dinamicamente -->
            </div>
        </section>

        <!-- Seção 7: Inventário Rápido -->
        <section class="bg-theme-panel border border-theme-border p-6 rounded-lg animate-fade-in-up anim-delay-4">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-theme-green/10 border border-theme-green/20">
                        <i data-lucide="package" class="w-4 h-4 text-theme-green"></i>
                    </div>
                    <h3 class="font-cinzel text-lg font-semibold text-white">Inventário Rápido</h3>
                </div>
                <button onclick="editarInventario()" class="text-sm text-theme-green hover:underline">
                    <i data-lucide="edit" class="w-3 h-3 inline mr-1"></i> Configurar
                </button>
            </div>

            <div class="flex justify-center gap-8" id="inventario-rapido">
                <!-- Itens serão carregados dinamicamente -->
            </div>
            <div class="text-center text-sm text-gray-500 mt-4">
                Clique em um item para usar rapidamente
            </div>
        </section>

        <!-- Seção 8: Mascote -->
        <div class="bg-gradient-to-br from-[#1a1510] to-[#2a2318] border border-[#8b7355] p-6 rounded-lg animate-fade-in-up anim-delay-4 card-hover">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-[#8b7355]/20 border border-[#8b7355]">
                        <i data-lucide="dog" class="w-4 h-4 text-[#d4a76a]"></i>
                    </div>
                    <h3 class="font-cinzel text-lg font-semibold text-[#f4d29a]">Mascote Companheiro</h3>
                </div>
                <div class="flex gap-2">
                    <button onclick="importarMascoteTXT()" class="text-sm text-theme-green hover:underline">
                        <i data-lucide="upload" class="w-3 h-3 inline mr-1"></i> Importar TXT
                    </button>
                    <button onclick="editarMascote()" class="text-sm text-[#d4a76a] hover:underline">
                        <i data-lucide="edit-3" class="w-3 h-3 inline mr-1"></i> Editar
                    </button>
                </div>
            </div>
            
            <div id="mascote-summary">
                <!-- Conteúdo será carregado dinamicamente -->
            </div>
        </div>

        <!-- Seção 9: Proficiências e Maestrias -->
        <section class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 p-6 rounded-lg animate-fade-in-up anim-delay-4">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-yellow-500/20 border border-yellow-500/30">
                        <i data-lucide="trophy" class="w-4 h-4 text-yellow-400"></i>
                    </div>
                    <h3 class="font-cinzel text-lg font-semibold text-white">Proficiências e Maestrias</h3>
                </div>
                <a href="proficiencias.html" class="text-sm text-yellow-400 hover:underline">
                    <i data-lucide="external-link" class="w-3 h-3 inline mr-1"></i> Gerenciar
                </a>
            </div>
            
            <div id="proficiencias-container">
                <div class="text-center py-4">
                    <i data-lucide="swords" class="w-12 h-12 mx-auto text-gray-600 mb-3"></i>
                    <p class="text-gray-500">Carregando proficiências...</p>
                </div>
            </div>
        </section>

    </div>

    <!-- Rodapé com botões de ação -->
    <div class="max-w-7xl mx-auto px-4 pb-12 pt-6 flex flex-wrap justify-end gap-4 border-t border-theme-border mt-6" data-html2pdf-ignore="true">
        <button onclick="exportarTXT()" 
            class="group flex items-center gap-2 px-6 py-3 bg-blue-900/30 hover:bg-blue-900/50 border border-blue-700/50 text-blue-300 rounded-lg transition-all font-cinzel text-sm font-bold">
            <i data-lucide="file-text" class="w-4 h-4"></i>
            <span>Exportar TXT</span>
        </button>
        
        <button onclick="exportarJSON()" 
            class="group flex items-center gap-2 px-6 py-3 bg-purple-900/30 hover:bg-purple-900/50 border border-purple-700/50 text-purple-300 rounded-lg transition-all font-cinzel text-sm font-bold">
            <i data-lucide="code" class="w-4 h-4"></i>
            <span>Exportar JSON</span>
        </button>
        
        <button onclick="importarPerfil()" 
            class="group flex items-center gap-2 px-6 py-3 bg-green-900/30 hover:bg-green-900/50 border border-green-700/50 text-green-300 rounded-lg transition-all font-cinzel text-sm font-bold">
            <i data-lucide="upload" class="w-4 h-4"></i>
            <span>Importar Perfil</span>
        </button>
        
        <button onclick="salvarPerfil()" 
            class="group flex items-center gap-2 px-6 py-3 bg-theme-orange hover:bg-orange-600 rounded-lg text-white shadow-lg transition-all font-cinzel text-sm font-bold">
            <i data-lucide="save" class="w-4 h-4"></i>
            <span>Salvar Perfil</span>
        </button>
    </div>

    <!-- Modal Principal -->
    <div id="edit-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
        <div class="bg-theme-panel border border-theme-border rounded-lg p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-cinzel font-bold text-xl text-white" id="modal-title">Editar</h3>
                <button onclick="fecharModal()" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div id="modal-content">
                <!-- Conteúdo será inserido dinamicamente -->
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="fecharModal()" 
                    class="px-4 py-2 border border-theme-border rounded-lg text-theme-text hover:bg-white/5 transition-colors">
                    Cancelar
                </button>
                <button onclick="salvarModal()" 
                    class="px-4 py-2 bg-theme-orange hover:bg-orange-600 rounded-lg text-white">
                    Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Sorte ISP -->
    <div id="sorte-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
        <div class="bg-theme-panel border border-theme-border rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-cinzel font-bold text-xl text-white">Rolagem de Sorte</h3>
                <button onclick="fecharSorteModal()" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="text-center mb-6">
                <div class="text-4xl font-bold font-mono mb-2" id="sorte-resultado-d100">--</div>
                <div class="text-lg text-gray-400" id="sorte-chance">Chance: --%</div>
            </div>
            
            <div class="mb-6">
                <div class="text-center mb-2">
                    <div class="text-sm text-gray-400">Índice de Sorte Final</div>
                    <div class="text-3xl font-bold text-theme-gold" id="sorte-isp-final">--%</div>
                </div>
                <div class="h-3 bg-theme-border rounded-full overflow-hidden mb-2">
                    <div id="sorte-isp-bar" class="h-full bg-gradient-to-r from-theme-purple to-theme-pink stat-bar-fill" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="text-center mb-4" id="sorte-resultado-texto">
                <!-- Resultado será inserido aqui -->
            </div>
            
            <div class="flex justify-center gap-3 mt-6">
                <button onclick="rolarDadoSorte()" 
                    class="px-6 py-3 bg-theme-purple hover:bg-purple-600 rounded-lg text-white font-cinzel font-bold">
                    <i data-lucide="dice-5" class="w-4 h-4 inline mr-2"></i> Rolar Novamente
                </button>
                <button onclick="fecharSorteModal()" 
                    class="px-6 py-3 border border-theme-border rounded-lg text-theme-text hover:bg-white/5 transition-colors">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Upload de Imagem -->
    <div id="upload-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
        <div class="bg-theme-panel border border-theme-border rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-cinzel font-bold text-xl text-white">Upload de Imagem</h3>
                <button onclick="fecharUploadModal()" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-2">Escolha uma imagem</label>
                <div class="upload-btn border-2 border-dashed border-theme-border rounded-lg p-8 text-center cursor-pointer hover:border-theme-blue transition-colors">
                    <i data-lucide="upload" class="w-10 h-10 mx-auto text-gray-500 mb-2"></i>
                    <p class="text-gray-400 mb-1">Arraste e solte ou clique para selecionar</p>
                    <p class="text-xs text-gray-600">PNG, JPG, GIF até 5MB</p>
                    <input type="file" id="file-input" accept="image/*" class="hidden">
                </div>
                <div id="image-preview" class="mt-4 hidden">
                    <img id="preview-image" class="max-w-full h-32 object-contain mx-auto rounded">
                </div>
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="fecharUploadModal()" 
                    class="px-4 py-2 border border-theme-border rounded-lg text-theme-text hover:bg-white/5 transition-colors">
                    Cancelar
                </button>
                <button onclick="confirmarUpload()" 
                    class="px-4 py-2 bg-theme-green hover:bg-green-600 rounded-lg text-white">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <script>
    // ====================================================================
    // SISTEMA DE PERFIL COMPLETO COM CORREÇÕES
    // ====================================================================

    // Inicializar ícones
    if (window.lucide) {
        lucide.createIcons();
    }

    // Variáveis globais
    let modalType = '';
    let modalData = {};
    let currentUploadType = '';
    let currentUploadTarget = '';
    let currentEquipamentoIndex = null;
    let currentHabilidadeIndex = null;
    let currentISPResult = null;

    // Dados do personagem
    const personagem = {
        nome: "Novo Personagem",
        classe: "Não Definida",
        nivel: 1,
        experiencia: 0,
        experienciaProximo: 1000,
        pontosDisponiveis: 0,
        pontosPorNivel: 2,
        pontosExtra: 0,
        
        // Status
        status: {
            vida: { atual: 100, max: 100 },
            mana: { atual: 50, max: 50 },
            estamina: { atual: 80, max: 80 },
            forca: 10,
            destreza: 10,
            constituicao: 10,
            inteligencia: 10,
            sabedoria: 10,
            carisma: 10
        },
        
        // Atributos para ISP
        atributosISP: {
            per: 10,  // Percepção
            sab: 10,  // Sabedoria
            agi: 10,  // Agilidade
            emocao: 3 // Emoção (1-5)
        },
        
        // Sorte
        sorte: {
            fe: 4,
            sorte: 5,
            destino: 2,
            indice: 50,
            status: "Neutro"
        },
        
        // Equipamentos (5 slots)
        equipamentos: Array(5).fill(null),
        
        // Habilidades (5 slots)
        habilidades: Array(5).fill(null),
        
        // Inventário rápido (3 slots)
        inventarioRapido: Array(3).fill(null),
        
        // Mascote
        mascote: null,
        
        // Avatar
        avatar: null,
        
        // Derivados (opcionais)
        derivados: {
            mostrar: true,
            blindagem: 0,
            velocidade: 0,
            iniciativa: 0,
            percepcao: 0
        }
    };

    // Classes disponíveis com bônus personalizados
    const classes = [
        { 
            nome: "Guerreiro", 
            cor: "#dc2626", 
            icone: "sword", 
            bonus: "+1 Força, +1 Constituição, +1 Destreza",
            atributosBonus: ['forca', 'constituicao', 'destreza']
        },
        { 
            nome: "Mago", 
            cor: "#4a9eff", 
            icone: "sparkles", 
            bonus: "+1 Inteligência, +1 Sabedoria, +1 Carisma",
            atributosBonus: ['inteligencia', 'sabedoria', 'carisma']
        },
        { 
            nome: "Arqueiro", 
            cor: "#22c55e", 
            icone: "crosshair", 
            bonus: "+1 Destreza, +1 Sabedoria, +1 Percepção",
            atributosBonus: ['destreza', 'sabedoria', 'percepcao']
        },
        { 
            nome: "Clérigo", 
            cor: "#8b5cf6", 
            icone: "heart", 
            bonus: "+1 Sabedoria, +1 Carisma, +1 Constituição",
            atributosBonus: ['sabedoria', 'carisma', 'constituicao']
        },
        { 
            nome: "Ladino", 
            cor: "#f59e0b", 
            icone: "eye", 
            bonus: "+1 Destreza, +1 Inteligência, +1 Carisma",
            atributosBonus: ['destreza', 'inteligencia', 'carisma']
        },
        { 
            nome: "Bárbaro", 
            cor: "#ef4444", 
            icone: "axe", 
            bonus: "+1 Força, +1 Constituição, +1 Destreza",
            atributosBonus: ['forca', 'constituicao', 'destreza']
        },
        { 
            nome: "Paladino", 
            cor: "#fbbf24", 
            icone: "shield", 
            bonus: "+1 Força, +1 Sabedoria, +1 Carisma",
            atributosBonus: ['forca', 'sabedoria', 'carisma']
        },
        { 
            nome: "Druida", 
            cor: "#10b981", 
            icone: "leaf", 
            bonus: "+1 Sabedoria, +1 Constituição, +1 Carisma",
            atributosBonus: ['sabedoria', 'constituicao', 'carisma']
        },
        {
            nome: "Personalizada",
            cor: "#8b5cf6",
            icone: "settings",
            bonus: "Defina seus próprios bônus",
            atributosBonus: []
        }
    ];

    // Emoções para ISP
    const emocaoISP = [
        { nome: "Calma", valor: 1, modificador: -10, cor: "#4a9eff" },
        { nome: "Dúvida", valor: 2, modificador: -5, cor: "#f59e0b" },
        { nome: "Raiva", valor: 3, modificador: 0, cor: "#dc2626" },
        { nome: "Medo", valor: 4, modificador: -5, cor: "#8b5cf6" },
        { nome: "Euforia", valor: 5, modificador: -10, cor: "#22c55e" }
    ];

    // ====================================================================
    // FUNÇÕES DE INICIALIZAÇÃO
    // ====================================================================

    function inicializar() {
        carregarDados();
        calcularRecursos(); // Calcular recursos baseados nos atributos
        atualizarInterface();
        atualizarTimestamp();
        inicializarISP();
        
        // Atualizar a cada 10 segundos
        setInterval(atualizarTimestamp, 10000);
        
        // Inicializar eventos de upload
        document.getElementById('file-input').addEventListener('change', previewImage);
        
        // Aplicar estilos aos botões de navegação
        const estilo = `
            .nav-btn {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem 1rem;
                border: 1px solid #2a2a2e;
                border-radius: 0.5rem;
                background: #0f0f12;
                color: #e8e4dc;
                font-size: 0.875rem;
                cursor: pointer;
                transition: all 0.2s;
            }
            .nav-btn:hover {
                background: #1a1a1e;
                border-color: #4a9eff;
                transform: translateY(-1px);
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = estilo;
        document.head.appendChild(styleSheet);
        
        console.log('Perfil inicializado com sucesso!');
    }

    function inicializarISP() {
        // Configurar botões de emoção
        const container = document.getElementById('emocao-buttons');
        let html = '';
        
        emocaoISP.forEach(emocao => {
            html += `
                <button onclick="selecionarEmocaoISP(${emocao.valor})" 
                        class="sorte-emotion-btn p-2 rounded-lg border text-xs ${personagem.atributosISP.emocao === emocao.valor ? 'selected' : ''}" 
                        style="color: ${emocao.cor}; border-color: ${emocao.cor}">
                    ${emocao.nome}<br>
                    <span class="text-xs">${emocao.modificador >= 0 ? '+' : ''}${emocao.modificador}%</span>
                </button>
            `;
        });
        
        container.innerHTML = html;
        
        // Calcular ISP inicial
        calcularISP();
    }

    function selecionarEmocaoISP(valor) {
        personagem.atributosISP.emocao = valor;
        document.getElementById('isp-emocao').value = valor;
        
        // Atualizar botões selecionados
        document.querySelectorAll('.sorte-emotion-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        document.querySelectorAll('.sorte-emotion-btn').forEach(btn => {
            if (btn.onclick && btn.onclick.toString().includes(`selecionarEmocaoISP(${valor})`)) {
                btn.classList.add('selected');
            }
        });
        
        calcularISP();
    }

    function calcularISP() {
        const per = parseInt(document.getElementById('isp-per').value) || personagem.atributosISP.per;
        const sab = parseInt(document.getElementById('isp-sab').value) || personagem.atributosISP.sab;
        const agi = parseInt(document.getElementById('isp-agi').value) || personagem.atributosISP.agi;
        const emocaoValor = parseInt(document.getElementById('isp-emocao').value) || personagem.atributosISP.emocao;
        
        // Atualizar dados
        personagem.atributosISP.per = per;
        personagem.atributosISP.sab = sab;
        personagem.atributosISP.agi = agi;
        personagem.atributosISP.emocao = emocaoValor;
        
        // Passo 1: Cálculo base
        const ispBase = ((per + sab + agi) * emocaoValor) / 3;
        
        // Passo 2: Modificador Emocional
        const emocao = emocaoISP.find(e => e.valor === emocaoValor);
        const modE = emocao ? emocao.modificador : 0;
        
        // Passo 3: Sorte Final
        let ispFinal = ispBase + modE;
        
        // Limite rígido: 5% mínimo, 95% máximo
        ispFinal = Math.max(5, Math.min(95, ispFinal));
        
        // Atualizar interface
        document.getElementById('display-sorte-isp').textContent = `${Math.round(ispFinal)}%`;
        document.getElementById('display-sorte-isp-bar').style.width = `${ispFinal}%`;
        
        // Determinar status narrativo
        let status = '';
        let corStatus = '';
        
        if (ispFinal >= 80) {
            status = 'Sorte quase milagrosa';
            corStatus = '#22c55e';
        } else if (ispFinal >= 60) {
            status = 'Sorte claramente favorável';
            corStatus = '#4a9eff';
        } else if (ispFinal >= 40) {
            status = 'Zona instável';
            corStatus = '#f59e0b';
        } else if (ispFinal >= 20) {
            status = 'Sorte contra';
            corStatus = '#dc2626';
        } else {
            status = 'Catástrofe iminente';
            corStatus = '#991b1b';
        }
        
        document.getElementById('isp-status').innerHTML = `Status: <span style="color: ${corStatus}">${status}</span>`;
        
        // Atualizar fórmula
        document.getElementById('isp-formula-display').innerHTML = 
            `Fórmula: ((${per} + ${sab} + ${agi}) × ${emocaoValor} ÷ 3) ${modE >= 0 ? '+' : ''}${modE} = ${Math.round(ispFinal)}%`;
        
        // Guardar resultado para rolagem
        currentISPResult = {
            ispFinal: Math.round(ispFinal),
            status: status,
            formula: `ISP = ((PER+${per} + SAB+${sab} + AGI+${agi}) × E+${emocaoValor} ÷ 3) ${modE >= 0 ? '+' : ''}${modE}`
        };
    }

    function rolarSorteISP() {
        if (!currentISPResult) {
            calcularISP();
        }
        
        // Rolagem 1d100
        const d100 = Math.floor(Math.random() * 100) + 1;
        const sucesso = d100 <= currentISPResult.ispFinal;
        
        // Atualizar modal
        document.getElementById('sorte-resultado-d100').textContent = d100;
        document.getElementById('sorte-chance').textContent = `Chance: ${currentISPResult.ispFinal}%`;
        document.getElementById('sorte-isp-final').textContent = `${currentISPResult.ispFinal}%`;
        document.getElementById('sorte-isp-bar').style.width = `${currentISPResult.ispFinal}%`;
        
        // Resultado textual
        const resultadoDiv = document.getElementById('sorte-resultado-texto');
        if (sucesso) {
            resultadoDiv.innerHTML = `
                <div class="p-4 rounded-lg bg-green-900/30 border border-green-700/50">
                    <div class="flex items-center justify-center gap-2 mb-2">
                        <i data-lucide="check-circle" class="w-6 h-6 text-green-400"></i>
                        <span class="text-xl font-bold text-green-400">SORTE FAVORECE!</span>
                    </div>
                    <p class="text-green-300">O destino está ao seu lado!</p>
                    <p class="text-sm text-green-400 mt-2">${d100} ≤ ${currentISPResult.ispFinal}%</p>
                </div>
            `;
            document.getElementById('sorte-resultado-d100').classList.remove('sorte-failure');
            document.getElementById('sorte-resultado-d100').classList.add('sorte-success');
        } else {
            resultadoDiv.innerHTML = `
                <div class="p-4 rounded-lg bg-red-900/30 border border-red-700/50">
                    <div class="flex items-center justify-center gap-2 mb-2">
                        <i data-lucide="x-circle" class="w-6 h-6 text-red-400"></i>
                        <span class="text-xl font-bold text-red-400">O CAOS VENCE!</span>
                    </div>
                    <p class="text-red-300">A sorte se voltou contra você!</p>
                    <p class="text-sm text-red-400 mt-2">${d100} > ${currentISPResult.ispFinal}%</p>
                </div>
            `;
            document.getElementById('sorte-resultado-d100').classList.remove('sorte-success');
            document.getElementById('sorte-resultado-d100').classList.add('sorte-failure');
        }
        
        // Mostrar resultado na seção também
        const resultadoSection = document.getElementById('isp-resultado');
        resultadoSection.innerHTML = `
            <div class="p-3 rounded-lg ${sucesso ? 'bg-green-900/20' : 'bg-red-900/20'}">
                <div class="flex items-center justify-center gap-2">
                    <i data-lucide="${sucesso ? 'check' : 'x'}" class="w-4 h-4 ${sucesso ? 'text-green-400' : 'text-red-400'}"></i>
                    <span class="${sucesso ? 'text-green-400' : 'text-red-400'}">Rolagem: ${d100} ${sucesso ? '≤' : '>'} ${currentISPResult.ispFinal}% - ${sucesso ? 'Sucesso!' : 'Falha!'}</span>
                </div>
            </div>
        `;
        resultadoSection.classList.remove('hidden');
        
        // Atualizar ícones
        if (window.lucide) lucide.createIcons();
        
        // Mostrar modal
        document.getElementById('sorte-modal').classList.remove('hidden');
    }

    function rolarDadoSorte() {
        rolarSorteISP();
    }

    function fecharSorteModal() {
        document.getElementById('sorte-modal').classList.add('hidden');
    }

    function carregarDados() {
        try {
            const dadosSalvos = localStorage.getItem('grimorio_perfil_completo');
            if (dadosSalvos) {
                const dados = JSON.parse(dadosSalvos);
                
                // Mesclar dados existentes com novos
                Object.keys(dados).forEach(key => {
                    if (key === 'status') {
                        // Para status, mesclar profundamente
                        Object.keys(dados[key]).forEach(subKey => {
                            if (personagem[key][subKey]) {
                                Object.assign(personagem[key][subKey], dados[key][subKey]);
                            }
                        });
                    } else if (typeof dados[key] === 'object' && dados[key] !== null) {
                        Object.assign(personagem[key], dados[key]);
                    } else {
                        personagem[key] = dados[key];
                    }
                });
                
                console.log('Dados carregados do localStorage');
            }
            
            // Sincronizar com GrimorioSystem se disponível
            if (window.GrimorioSystem && GrimorioSystem.carregarPersonagem) {
                const dadosGrimorio = GrimorioSystem.carregarPersonagem();
                if (dadosGrimorio) {
                    sincronizarComGrimorio(dadosGrimorio);
                }
            }
        } catch (error) {
            console.error('Erro ao carregar dados:', error);
        }
    }

    function sincronizarComGrimorio(dadosGrimorio) {
        // Sincronizar dados básicos
        personagem.nome = dadosGrimorio.nome || personagem.nome;
        personagem.classe = dadosGrimorio.classe || personagem.classe;
        personagem.nivel = dadosGrimorio.nivel || personagem.nivel;
        personagem.pontosDisponiveis = dadosGrimorio.pontosDisponiveis || personagem.pontosDisponiveis;
        
        // Sincronizar atributos
        if (dadosGrimorio.atributos) {
            personagem.status.forca = dadosGrimorio.atributos.forca || 10;
            personagem.status.destreza = dadosGrimorio.atributos.destreza || 10;
            personagem.status.constituicao = dadosGrimorio.atributos.constituicao || 10;
            personagem.status.inteligencia = dadosGrimorio.atributos.inteligencia || 10;
            personagem.status.sabedoria = dadosGrimorio.atributos.sabedoria || 10;
            personagem.status.carisma = dadosGrimorio.atributos.carisma || 10;
        }
        
        // Calcular recursos baseados nos atributos
        calcularRecursos();
        
        // Calcular derivados
        calcularDerivadosAutomaticos();
    }

    function salvarDados() {
        try {
            localStorage.setItem('grimorio_perfil_completo', JSON.stringify(personagem));
            console.log('Dados salvos no localStorage');
            
            // Sincronizar com GrimorioSystem
            if (window.GrimorioSystem && GrimorioSystem.salvarPersonagem) {
                const dadosParaGrimorio = {
                    nome: personagem.nome,
                    classe: personagem.classe,
                    nivel: personagem.nivel,
                    pontosDisponiveis: personagem.pontosDisponiveis,
                    atributos: {
                        forca: personagem.status.forca,
                        destreza: personagem.status.destreza,
                        constituicao: personagem.status.constituicao,
                        inteligencia: personagem.status.inteligencia,
                        sabedoria: personagem.status.sabedoria,
                        carisma: personagem.status.carisma
                    },
                    recursos: {
                        vidaMaxima: personagem.status.vida.max,
                        vidaAtual: personagem.status.vida.atual,
                        manaMaxima: personagem.status.mana.max,
                        manaAtual: personagem.status.mana.atual,
                        estaminaMaxima: personagem.status.estamina.max,
                        estaminaAtual: personagem.status.estamina.atual
                    }
                };
                GrimorioSystem.salvarPersonagem(dadosParaGrimorio);
            }
            
            mostrarNotificacao('Perfil salvo com sucesso!', 'success');
        } catch (error) {
            console.error('Erro ao salvar dados:', error);
            mostrarNotificacao('Erro ao salvar perfil', 'error');
        }
    }

    // ====================================================================
    // ATUALIZAÇÃO DA INTERFACE
    // ====================================================================

    function atualizarInterface() {
        // Avatar
        atualizarAvatar();
        
        // Status
        atualizarStatus();
        
        // Atributos
        atualizarAtributos();
        
        // Classe e Pontos
        atualizarClassePontos();
        
        // Sorte
        atualizarSorte();
        
        // Estatísticas Avançadas
        atualizarEstatisticasAvancadas();
        
        // Equipamentos
        atualizarEquipamentos();
        
        // Habilidades
        atualizarHabilidades();
        
        // Inventário Rápido
        atualizarInventarioRapido();
        
        // Mascote
        atualizarMascote();
        
        // Proficiências
        carregarProficiencias();
        
        // ISP
        if (currentISPResult) {
            calcularISP();
        }
    }

    function atualizarAvatar() {
        const avatarImg = document.getElementById('avatar-image');
        const avatarIcon = document.getElementById('avatar-icon');
        
        if (personagem.avatar) {
            avatarImg.src = personagem.avatar;
            avatarImg.classList.remove('hidden');
            avatarIcon.classList.add('hidden');
        } else {
            avatarImg.classList.add('hidden');
            avatarIcon.classList.remove('hidden');
        }
        
        // Atualizar título do perfil
        document.getElementById('profile-title').textContent = personagem.nome;
        document.getElementById('profile-subtitle').textContent = `${personagem.classe} - Nível ${personagem.nivel}`;
    }

    function calcularRecursos() {
        // Vida: Base 100 + (CON × 2)
        personagem.status.vida.max = 100 + (personagem.status.constituicao * 2);
        
        // Mana: Base 50 + (INT × 3)
        personagem.status.mana.max = 50 + (personagem.status.inteligencia * 3);
        
        // Estamina: Base 80 + (DES + CON)
        personagem.status.estamina.max = 80 + personagem.status.destreza + personagem.status.constituicao;
        
        // Garantir que valores atuais não excedam máximos
        personagem.status.vida.atual = Math.min(personagem.status.vida.atual, personagem.status.vida.max);
        personagem.status.mana.atual = Math.min(personagem.status.mana.atual, personagem.status.mana.max);
        personagem.status.estamina.atual = Math.min(personagem.status.estamina.atual, personagem.status.estamina.max);
        
        atualizarStatus();
    }

    function atualizarStatus() {
        // Vida
        const vida = personagem.status.vida;
        const vidaPercent = vida.max > 0 ? (vida.atual / vida.max) * 100 : 0;
        document.getElementById('display-vida').textContent = `${vida.atual}/${vida.max}`;
        document.getElementById('display-vida-bar').style.width = `${vidaPercent}%`;
        document.getElementById('vida-percent').textContent = `${Math.round(vidaPercent)}%`;
        document.getElementById('vida-formula').textContent = `Base: 100 + (CON × 2 = ${personagem.status.constituicao * 2})`;
        
        // Mana
        const mana = personagem.status.mana;
        const manaPercent = mana.max > 0 ? (mana.atual / mana.max) * 100 : 0;
        document.getElementById('display-mana').textContent = `${mana.atual}/${mana.max}`;
        document.getElementById('display-mana-bar').style.width = `${manaPercent}%`;
        document.getElementById('mana-percent').textContent = `${Math.round(manaPercent)}%`;
        document.getElementById('mana-formula').textContent = `Base: 50 + (INT × 3 = ${personagem.status.inteligencia * 3})`;
        
        // Estamina
        const estamina = personagem.status.estamina;
        const estaminaPercent = estamina.max > 0 ? (estamina.atual / estamina.max) * 100 : 0;
        document.getElementById('display-estamina').textContent = `${estamina.atual}/${estamina.max}`;
        document.getElementById('display-estamina-bar').style.width = `${estaminaPercent}%`;
        document.getElementById('estamina-percent').textContent = `${Math.round(estaminaPercent)}%`;
        document.getElementById('estamina-formula').textContent = `Base: 80 + (DES+${personagem.status.destreza} + CON+${personagem.status.constituicao})`;
    }

    function atualizarAtributos() {
        const atributos = [
            { id: 'forca', nome: 'Força', valor: personagem.status.forca, cor: 'red' },
            { id: 'destreza', nome: 'Destreza', valor: personagem.status.destreza, cor: 'green' },
            { id: 'constituicao', nome: 'Constituição', valor: personagem.status.constituicao, cor: 'yellow' },
            { id: 'inteligencia', nome: 'Inteligência', valor: personagem.status.inteligencia, cor: 'blue' },
            { id: 'sabedoria', nome: 'Sabedoria', valor: personagem.status.sabedoria, cor: 'purple' },
            { id: 'carisma', nome: 'Carisma', valor: personagem.status.carisma, cor: 'pink' }
        ];
        
        let html = '';
        atributos.forEach(attr => {
            html += `
                <div class="text-center">
                    <div class="text-lg font-bold text-theme-${attr.cor}" id="display-${attr.id}">${attr.valor}</div>
                    <div class="text-xs text-gray-500">${attr.nome}</div>
                    <div class="flex justify-center gap-1 mt-1">
                        <button onclick="alterarAtributo('${attr.id}', -1)" class="w-5 h-5 text-xs hover:bg-white/10 rounded">-</button>
                        <button onclick="alterarAtributo('${attr.id}', 1)" class="w-5 h-5 text-xs hover:bg-white/10 rounded">+</button>
                    </div>
                </div>
            `;
        });
        
        document.getElementById('atributos-container').innerHTML = html;
    }

    function atualizarClassePontos() {
        // Classe
        const classe = classes.find(c => c.nome === personagem.classe);
        let classeHTML = `
            <div class="text-center py-4">
                <i data-lucide="user-plus" class="w-12 h-12 mx-auto text-destiny-dark mb-3"></i>
                <p class="text-destiny-dark">Nenhuma classe selecionada</p>
            </div>
        `;
        
        if (classe) {
            classeHTML = `
                <div class="text-center">
                    <div class="w-16 h-16 mx-auto mb-3 rounded-full flex items-center justify-center" style="background-color: ${classe.cor}20; border: 2px solid ${classe.cor}40">
                        <i data-lucide="${classe.icone}" class="w-8 h-8" style="color: ${classe.cor}"></i>
                    </div>
                    <h5 class="text-xl font-bold text-destiny-light mb-1">${classe.nome}</h5>
                    <p class="text-sm text-destiny-dark mb-3">${classe.bonus}</p>
                    <div class="text-xs text-destiny-gold bg-destiny-1 px-3 py-1 rounded-full inline-block">
                        Bônus de Classe Ativo
                    </div>
                </div>
            `;
        }
        
        document.getElementById('classe-info').innerHTML = classeHTML;
        
        // Pontos
        const pontosPercent = Math.min(100, (personagem.pontosDisponiveis / 20) * 100);
        document.getElementById('pontos-disponiveis').textContent = personagem.pontosDisponiveis;
        document.getElementById('pontos-progress').style.width = `${pontosPercent}%`;
        document.getElementById('pontos-nivel').textContent = `+${personagem.pontosPorNivel} pontos por nível`;
        
        // Nível e Experiência
        const expPercent = Math.min(100, (personagem.experiencia / personagem.experienciaProximo) * 100);
        document.getElementById('nivel-personagem').textContent = personagem.nivel;
        document.getElementById('experiencia-personagem').textContent = `${personagem.experiencia}/${personagem.experienciaProximo}`;
        document.getElementById('exp-progress').style.width = `${expPercent}%`;
        
        // Atualizar ícones
        if (window.lucide) lucide.createIcons();
    }

    function alterarNivel(delta) {
        const novoNivel = Math.max(1, personagem.nivel + delta);
        
        if (novoNivel > personagem.nivel) {
            // Subir de nível
            for (let i = personagem.nivel; i < novoNivel; i++) {
                personagem.pontosDisponiveis += personagem.pontosPorNivel;
            }
        } else if (novoNivel < personagem.nivel) {
            // Descer de nível
            for (let i = personagem.nivel; i > novoNivel; i--) {
                personagem.pontosDisponiveis = Math.max(0, personagem.pontosDisponiveis - personagem.pontosPorNivel);
            }
        }
        
        personagem.nivel = novoNivel;
        personagem.experienciaProximo = 1000 * personagem.nivel; // XP necessário aumenta com o nível
        
        atualizarClassePontos();
        salvarDados();
        mostrarNotificacao(`Nível alterado para ${novoNivel}!`, 'success');
    }

    function adicionarExperiencia() {
        const input = document.getElementById('add-exp-input');
        const xp = parseInt(input.value) || 0;
        
        if (xp > 0) {
            personagem.experiencia += xp;
            
            // Verificar se passou de nível
            while (personagem.experiencia >= personagem.experienciaProximo) {
                personagem.experiencia -= personagem.experienciaProximo;
                personagem.nivel++;
                personagem.pontosDisponiveis += personagem.pontosPorNivel;
                personagem.experienciaProximo = 1000 * personagem.nivel;
                
                mostrarNotificacao(`Parabéns! Você subiu para o nível ${personagem.nivel}!`, 'success');
            }
            
            input.value = '';
            atualizarClassePontos();
            salvarDados();
            mostrarNotificacao(`${xp} XP adicionados!`, 'success');
        }
    }

    function atualizarSorte() {
        const sorte = personagem.sorte;
        const indice = ((sorte.fe + sorte.destino) * 2 - sorte.sorte) / 2;
        const percentual = Math.max(0, Math.min(100, indice * 5 + 50));
        
        personagem.sorte.indice = percentual;
        personagem.sorte.status = percentual >= 60 ? "Sorte Alta" : percentual <= 40 ? "Sorte Baixa" : "Neutro";
        
        // Atualizar ISP também
        calcularISP();
    }

    function calcularDerivadosAutomaticos() {
        if (!personagem.derivados.mostrar) return;
        
        // Blindagem: CON / 10
        personagem.derivados.blindagem = Math.floor(personagem.status.constituicao / 10);
        
        // Velocidade: DES / 5
        personagem.derivados.velocidade = Math.floor(personagem.status.destreza / 5);
        
        // Iniciativa: (DES + SAB) / 8
        personagem.derivados.iniciativa = Math.floor((personagem.status.destreza + personagem.status.sabedoria) / 8);
        
        // Percepção: SAB / 4
        personagem.derivados.percepcao = Math.floor(personagem.status.sabedoria / 4);
        
        atualizarEstatisticasAvancadas();
    }

    function atualizarEstatisticasAvancadas() {
        if (!personagem.derivados.mostrar) {
            document.getElementById('estatisticas-avancadas').classList.add('hidden');
            return;
        }
        
        document.getElementById('estatisticas-avancadas').classList.remove('hidden');
        
        const estatisticas = [
            { 
                id: 'blindagem', 
                nome: 'Blindagem', 
                valor: personagem.derivados.blindagem, 
                cor: 'gray', 
                icone: 'shield',
                formula: 'CON / 10'
            },
            { 
                id: 'velocidade', 
                nome: 'Velocidade', 
                valor: personagem.derivados.velocidade, 
                cor: 'green', 
                icone: 'zap',
                formula: 'DES / 5'
            },
            { 
                id: 'iniciativa', 
                nome: 'Iniciativa', 
                valor: personagem.derivados.iniciativa, 
                cor: 'blue', 
                icone: 'clock',
                formula: '(DES + SAB) / 8'
            },
            { 
                id: 'percepcao', 
                nome: 'Percepção', 
                valor: personagem.derivados.percepcao, 
                cor: 'purple', 
                icone: 'eye',
                formula: 'SAB / 4'
            }
        ];
        
        let html = '';
        estatisticas.forEach(stat => {
            html += `
                <div class="text-center bg-[#0a0a0c] p-4 rounded-lg border border-theme-border card-hover">
                    <div class="inline-block p-2 rounded-lg mb-2" style="background-color: var(--theme-${stat.cor}20)">
                        <i data-lucide="${stat.icone}" class="w-5 h-5" style="color: var(--theme-${stat.cor})"></i>
                    </div>
                    <div class="text-2xl font-bold text-white font-mono" id="display-${stat.id}">${stat.valor}</div>
                    <div class="text-xs uppercase text-gray-500 mt-1">${stat.nome}</div>
                    <div class="text-xs text-gray-600 mt-1">${stat.formula}</div>
                </div>
            `;
        });
        
        document.querySelector('#estatisticas-avancadas .grid').innerHTML = html;
        
        // Atualizar ícones
        if (window.lucide) lucide.createIcons();
    }

    function atualizarEquipamentos() {
        const container = document.getElementById('equipamentos-container');
        let html = '';
        
        for (let i = 0; i < 5; i++) {
            const equipamento = personagem.equipamentos[i];
            
            if (equipamento) {
                html += `
                    <div class="item-slot filled card-hover" onclick="editarEquipamento(${i})">
                        <div class="absolute top-2 right-2 text-xs px-2 py-1 rounded" style="background-color: ${equipamento.raridadeCor || '#8b7355'}20; color: ${equipamento.raridadeCor || '#d4a76a'}">
                            ${equipamento.raridade || 'Comum'}
                        </div>
                        <div class="flex items-center justify-center mb-3">
                            ${equipamento.imagem ? 
                                `<img src="${equipamento.imagem}" alt="${equipamento.nome}" class="w-12 h-12 object-contain">` :
                                `<i data-lucide="${equipamento.icone || 'sword'}" class="w-10 h-10 text-theme-orange"></i>`
                            }
                        </div>
                        <div class="font-bold text-white text-sm mb-1 truncate">${equipamento.nome}</div>
                        <div class="text-xs text-gray-400 mb-2">${equipamento.tipo || 'Equipamento'}</div>
                        ${equipamento.bonus ? `<div class="text-xs text-theme-green mb-1">${equipamento.bonus}</div>` : ''}
                        <div class="text-xs text-gray-500 truncate">${equipamento.descricao || ''}</div>
                    </div>
                `;
            } else {
                html += `
                    <div class="item-slot text-center card-hover" onclick="editarEquipamento(${i})">
                        <i data-lucide="plus" class="w-8 h-8 text-gray-600 mx-auto mb-3"></i>
                        <div class="text-sm text-gray-500">Clique para adicionar</div>
                        <div class="text-xs text-gray-600 mt-2">Slot ${i + 1}</div>
                    </div>
                `;
            }
        }
        
        container.innerHTML = html;
        
        // Atualizar ícones
        if (window.lucide) lucide.createIcons();
    }

    function atualizarHabilidades() {
        const container = document.getElementById('habilidades-container');
        let html = '';
        
        for (let i = 0; i < 5; i++) {
            const habilidade = personagem.habilidades[i];
            
            if (habilidade) {
                html += `
                    <div class="item-slot filled card-hover" onclick="editarHabilidade(${i})">
                        <div class="absolute top-2 right-2 text-xs px-2 py-1 rounded bg-${habilidade.tipoCor || 'purple'}-900/30 text-${habilidade.tipoCor || 'purple'}-400">
                            ${habilidade.tipo || 'Ativa'}
                        </div>
                        <div class="flex items-center justify-center mb-3">
                            ${habilidade.imagem ? 
                                `<img src="${habilidade.imagem}" alt="${habilidade.nome}" class="w-12 h-12 object-contain">` :
                                `<i data-lucide="${habilidade.icone || 'zap'}" class="w-10 h-10 text-theme-purple"></i>`
                            }
                        </div>
                        <div class="font-bold text-white text-sm mb-1 truncate">${habilidade.nome}</div>
                        <div class="text-xs text-gray-400 mb-2">Nível ${habilidade.nivel || 1}</div>
                        ${habilidade.custo ? `<div class="text-xs text-theme-blue mb-1">Custo: ${habilidade.custo}</div>` : ''}
                        ${habilidade.cooldown ? `<div class="text-xs text-theme-orange mb-1">CD: ${habilidade.cooldown}s</div>` : ''}
                        <div class="text-xs text-gray-500 truncate">${habilidade.descricao || ''}</div>
                    </div>
                `;
            } else {
                html += `
                    <div class="item-slot text-center card-hover" onclick="editarHabilidade(${i})">
                        <i data-lucide="plus" class="w-8 h-8 text-gray-600 mx-auto mb-3"></i>
                        <div class="text-sm text-gray-500">Clique para adicionar</div>
                        <div class="text-xs text-gray-600 mt-2">Slot ${i + 1}</div>
                    </div>
                `;
            }
        }
        
        container.innerHTML = html;
        
        // Atualizar ícones
        if (window.lucide) lucide.createIcons();
    }

    function atualizarInventarioRapido() {
        const container = document.getElementById('inventario-rapido');
        let html = '';
        
        for (let i = 0; i < 3; i++) {
            const item = personagem.inventarioRapido[i];
            
            if (item && item.imagem) {
                html += `
                    <div class="quick-item card-hover" onclick="usarItem(${i})" title="${item.nome || 'Item'}">
                        <img src="${item.imagem}" alt="${item.nome || 'Item'}" class="w-10 h-10 object-contain">
                        ${item.quantidade ? `<div class="absolute -top-1 -right-1 bg-theme-red text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">${item.quantidade}</div>` : ''}
                    </div>
                `;
            } else {
                html += `
                    <div class="quick-item card-hover" onclick="usarItem(${i})">
                        <i data-lucide="package" class="w-6 h-6 text-gray-600"></i>
                    </div>
                `;
            }
        }
        
        container.innerHTML = html;
        
        // Atualizar ícones
        if (window.lucide) lucide.createIcons();
    }

    function atualizarMascote() {
        const container = document.getElementById('mascote-summary');
        
        if (personagem.mascote) {
            container.innerHTML = `
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="text-center">
                        ${personagem.mascote.imagem ? 
                            `<img src="${personagem.mascote.imagem}" alt="${personagem.mascote.nome}" class="w-32 h-32 object-contain mx-auto rounded-lg mb-4">` :
                            `<div class="w-32 h-32 mx-auto mb-4 rounded-lg bg-destiny-2 border border-destiny flex items-center justify-center">
                                <i data-lucide="dog" class="w-16 h-16 text-destiny-dark"></i>
                            </div>`
                        }
                        <h4 class="text-xl font-bold text-destiny-light">${personagem.mascote.nome}</h4>
                        <p class="text-destiny-dark">${personagem.mascote.tipo || 'Companheiro'}</p>
                    </div>
                    <div>
                        <h5 class="font-bold text-destiny-light mb-3">Informações</h5>
                        ${personagem.mascote.nivel ? `<p class="text-sm text-destiny-dark mb-1"><span class="text-destiny-gold">Nível:</span> ${personagem.mascote.nivel}</p>` : ''}
                        ${personagem.mascote.habilidades ? `<p class="text-sm text-destiny-dark mb-1"><span class="text-destiny-gold">Habilidades:</span> ${personagem.mascote.habilidades}</p>` : ''}
                        ${personagem.mascote.descricao ? `<p class="text-sm text-destiny-dark mt-3">${personagem.mascote.descricao}</p>` : ''}
                        ${personagem.mascote.importadoEm ? `<p class="text-xs text-destiny-dark/70 mt-4">Importado em: ${personagem.mascote.importadoEm}</p>` : ''}
                    </div>
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="text-center py-8 text-[#8b7355]">
                    <i data-lucide="dog" class="w-16 h-16 mx-auto mb-3 opacity-50"></i>
                    <p class="text-lg mb-2">Nenhum mascote vinculado</p>
                    <p class="text-sm mb-4">Crie um mascote para acompanhar seu personagem</p>
                    <button onclick="importarMascoteTXT()" class="px-4 py-2 bg-[#8b7355]/20 hover:bg-[#8b7355]/30 text-[#d4a76a] border border-[#8b7355] rounded-lg transition-colors text-sm">
                        <i data-lucide="upload" class="w-3 h-3 inline mr-1"></i> Importar do TXT
                    </button>
                </div>
            `;
        }
        
        // Atualizar ícones
        if (window.lucide) lucide.createIcons();
    }

    async function carregarProficiencias() {
        const container = document.getElementById('proficiencias-container');
        
        try {
            const proficienciasData = localStorage.getItem('rpg_proficiencias');
            if (!proficienciasData) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i data-lucide="swords" class="w-12 h-12 mx-auto text-gray-600 mb-3"></i>
                        <p class="text-gray-500">Nenhuma proficiência encontrada</p>
                        <p class="text-sm text-gray-600 mt-2">Visite a página de Estilos de Combate para adicionar proficiências</p>
                    </div>
                `;
                return;
            }
            
            const dados = JSON.parse(proficienciasData);
            
            // Contar proficiências e calcular pontos
            let totalProficiencias = 0;
            let totalPontos = 0;
            let totalMaestrias = 0;
            let proficienciasSalvas = 0;
            
            // Função para contar em uma categoria
            function contarCategoria(categoria) {
                if (!categoria) return;
                
                if (Array.isArray(categoria)) {
                    // Array simples (magia, pactos, etc)
                    categoria.forEach(habilidade => {
                        if (habilidade && habilidade.nivel) {
                            totalProficiencias++;
                            totalPontos += Math.floor(habilidade.nivel / 10);
                            if (habilidade.nivel >= 10) totalMaestrias++;
                            proficienciasSalvas++;
                        }
                    });
                } else if (typeof categoria === 'object') {
                    // Objeto com subcategorias (armas)
                    Object.values(categoria).forEach(subcat => {
                        if (Array.isArray(subcat)) {
                            subcat.forEach(habilidade => {
                                if (habilidade && habilidade.nivel) {
                                    totalProficiencias++;
                                    totalPontos += Math.floor(habilidade.nivel / 10);
                                    if (habilidade.nivel >= 10) totalMaestrias++;
                                    proficienciasSalvas++;
                                }
                            });
                        }
                    });
                }
            }
            
            // Contar em todas as categorias
            ['armas', 'magia', 'pactos', 'invocacao', 'especiais'].forEach(cat => {
                contarCategoria(dados[cat]);
            });
            
            // Limitar proficiencias salvas ao máximo de 5 (como especificado)
            proficienciasSalvas = Math.min(proficienciasSalvas, 5);
            
            const porcentagemMaestria = totalProficiencias > 0 ? Math.round((totalMaestrias / totalProficiencias) * 100) : 0;
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-gray-800/50 border border-gray-700/50 p-4 rounded-lg">
                        <div class="text-3xl font-bold text-yellow-400 mb-1">${totalMaestrias}</div>
                        <div class="text-sm text-gray-400">Maestrias</div>
                        <div class="text-xs text-yellow-600 mt-1">Nível 10 alcançado</div>
                    </div>
                    <div class="bg-gray-800/50 border border-gray-700/50 p-4 rounded-lg">
                        <div class="text-3xl font-bold text-blue-400 mb-1">${totalProficiencias}</div>
                        <div class="text-sm text-gray-400">Total</div>
                        <div class="text-xs text-blue-600 mt-1">Proficiências</div>
                    </div>
                    <div class="bg-gray-800/50 border border-gray-700/50 p-4 rounded-lg">
                        <div class="text-3xl font-bold text-green-400 mb-1">${totalPontos}</div>
                        <div class="text-sm text-gray-400">Pontos</div>
                        <div class="text-xs text-green-600 mt-1">1 ponto a cada 10 níveis</div>
                    </div>
                    <div class="bg-gray-800/50 border border-gray-700/50 p-4 rounded-lg">
                        <div class="text-3xl font-bold text-purple-400 mb-1">${proficienciasSalvas}/5</div>
                        <div class="text-sm text-gray-400">Salvas</div>
                        <div class="text-xs text-purple-600 mt-1">Máximo permitido</div>
                    </div>
                </div>
                
                ${totalMaestrias > 0 ? `
                    <div class="mb-6">
                        <h4 class="font-medium text-white mb-3 flex items-center gap-2">
                            <i data-lucide="crown" class="w-4 h-4 text-yellow-400"></i>
                            Progresso de Maestria
                        </h4>
                        <div class="bg-gray-900/50 border border-gray-800 rounded-lg p-4">
                            <div class="h-3 bg-gray-800 rounded-full overflow-hidden mb-2">
                                <div class="h-full bg-gradient-to-r from-yellow-500 to-orange-500" style="width: ${porcentagemMaestria}%"></div>
                            </div>
                            <div class="text-sm text-gray-400 text-center">
                                ${porcentagemMaestria}% das habilidades em maestria
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                <div class="text-center">
                    <a href="proficiencias.html" 
                       class="inline-flex items-center gap-2 px-4 py-2 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg transition-colors text-sm">
                        <i data-lucide="external-link" class="w-4 h-4"></i>
                        Gerenciar Proficiências
                    </a>
                </div>
            `;
            
        } catch (error) {
            console.error('Erro ao carregar proficiências:', error);
            container.innerHTML = `
                <div class="text-center py-4">
                    <i data-lucide="alert-circle" class="w-12 h-12 mx-auto text-red-500 mb-3"></i>
                    <p class="text-gray-500">Erro ao carregar proficiências</p>
                    <p class="text-sm text-gray-600 mt-2">${error.message}</p>
                </div>
            `;
        }
        
        // Atualizar ícones
        if (window.lucide) lucide.createIcons();
    }

    // ====================================================================
    // FUNÇÕES DE INTERAÇÃO
    // ====================================================================

    function alterarAtributo(atributo, delta) {
        if (personagem.pontosDisponiveis < delta && delta > 0) {
            mostrarNotificacao('Pontos insuficientes!', 'error');
            return;
        }
        
        personagem.status[atributo] = Math.max(0, Math.min(100, personagem.status[atributo] + delta));
        personagem.pontosDisponiveis -= delta;
        
        // Recalcular recursos e derivados
        calcularRecursos();
        calcularDerivadosAutomaticos();
        
        // Se for PER, SAB ou AGI, atualizar ISP também
        if (['sabedoria', 'destreza'].includes(atributo)) {
            // Mapear atributos para ISP
            if (atributo === 'sabedoria') {
                personagem.atributosISP.sab = personagem.status.sabedoria;
                document.getElementById('isp-sab').value = personagem.status.sabedoria;
            } else if (atributo === 'destreza') {
                personagem.atributosISP.agi = personagem.status.destreza;
                document.getElementById('isp-agi').value = personagem.status.destreza;
            }
            calcularISP();
        }
        
        atualizarInterface();
        salvarDados();
    }

    function toggleDerivados() {
        personagem.derivados.mostrar = !personagem.derivados.mostrar;
        
        if (personagem.derivados.mostrar) {
            calcularDerivadosAutomaticos();
        }
        
        atualizarEstatisticasAvancadas();
        salvarDados();
        
        const botao = document.querySelector('#estatisticas-avancadas button');
        if (botao) {
            botao.innerHTML = personagem.derivados.mostrar ? 
                '<i data-lucide="eye-off" class="w-3 h-3 inline mr-1"></i> Ocultar' :
                '<i data-lucide="eye" class="w-3 h-3 inline mr-1"></i> Mostrar';
        }
        
        if (window.lucide) lucide.createIcons();
    }

    // [As outras funções permanecem similares, apenas ajustando para usar calcularRecursos() onde necessário]

    // ====================================================================
    // MODAIS E FUNÇÕES EXISTENTES
    // ====================================================================

    // [Mantive as funções existentes de modal, upload, exportação, etc., apenas ajustando onde necessário]

    // Exemplo de função atualizada para editar classe:
    function editarClasse() {
        modalType = 'classe';
        
        document.getElementById('modal-title').textContent = 'Selecionar Classe';
        document.getElementById('modal-content').innerHTML = `
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Nome do Personagem</label>
                    <input type="text" id="modal-nome" value="${personagem.nome}" 
                           class="w-full bg-[#0a0a0c] border border-theme-border rounded-lg px-3 py-2 text-white">
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Selecione uma Classe</label>
                    <div class="grid grid-cols-2 gap-3" id="classes-list">
                        ${classes.map(classe => `
                            <button onclick="selecionarClasse('${classe.nome}')" 
                                    class="p-3 rounded-lg border text-left transition-all ${personagem.classe === classe.nome ? 'border-' + classe.cor.replace('#', '') + ' bg-' + classe.cor.replace('#', '') + '20' : 'border-theme-border hover:border-' + classe.cor.replace('#', '')}">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 rounded" style="background-color: ${classe.cor}20">
                                        <i data-lucide="${classe.icone}" class="w-4 h-4" style="color: ${classe.cor}"></i>
                                    </div>
                                    <div>
                                        <div class="font-medium text-white">${classe.nome}</div>
                                        <div class="text-xs text-gray-400">${classe.bonus}</div>
                                    </div>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                </div>
                
                <div class="p-4 bg-theme-panel/50 rounded-lg">
                    <div class="text-sm text-gray-400 mb-2">Bônus da Classe</div>
                    <div class="text-xs text-gray-500">
                        Ao selecionar uma classe, você recebe +1 em 3 atributos específicos.
                        Para classes personalizadas, você pode escolher quais atributos recebem bônus.
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Pontos por Nível</label>
                    <div class="flex items-center gap-4">
                        <button onclick="alterarPontosPorNivel(-1)" class="w-10 h-10 rounded-full bg-theme-panel border border-theme-border flex items-center justify-center hover:bg-white/5">-</button>
                        <div class="text-center flex-1">
                            <div class="text-3xl font-bold text-white" id="pontos-por-nivel-display">${personagem.pontosPorNivel}</div>
                            <div class="text-xs text-gray-500">Pontos por Nível</div>
                        </div>
                        <button onclick="alterarPontosPorNivel(1)" class="w-10 h-10 rounded-full bg-theme-panel border border-theme-border flex items-center justify-center hover:bg-white/5">+</button>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('edit-modal').classList.remove('hidden');
        
        // Atualizar ícones
        if (window.lucide) lucide.createIcons();
    }

    function selecionarClasse(nomeClasse) {
        const classeAnterior = classes.find(c => c.nome === personagem.classe);
        const novaClasse = classes.find(c => c.nome === nomeClasse);
        
        // Remover bônus da classe anterior
        if (classeAnterior && classeAnterior.atributosBonus && classeAnterior.atributosBonus.length > 0) {
            classeAnterior.atributosBonus.forEach(atributo => {
                if (personagem.status[atributo] > 0) {
                    personagem.status[atributo] = Math.max(0, personagem.status[atributo] - 1);
                }
            });
        }
        
        // Aplicar bônus da nova classe
        personagem.classe = nomeClasse;
        
        if (novaClasse && novaClasse.atributosBonus && novaClasse.atributosBonus.length > 0) {
            novaClasse.atributosBonus.forEach(atributo => {
                personagem.status[atributo] += 1;
            });
        }
        
        // Recalcular recursos
        calcularRecursos();
        calcularDerivadosAutomaticos();
        
        // Atualizar interface
        const botao = document.querySelector(`[onclick="selecionarClasse('${nomeClasse}')"]`);
        document.querySelectorAll('#classes-list button').forEach(btn => {
            btn.classList.remove('border-blue-500', 'bg-blue-500/20');
        });
        if (botao) {
            const corClasse = novaClasse.cor.replace('#', '');
            botao.classList.add(`border-${corClasse}`, `bg-${corClasse}20`);
        }
    }

    function alterarPontosPorNivel(delta) {
        personagem.pontosPorNivel = Math.max(1, personagem.pontosPorNivel + delta);
        document.getElementById('pontos-por-nivel-display').textContent = personagem.pontosPorNivel;
    }

    // ====================================================================
    // UTILITÁRIOS
    // ====================================================================

    function atualizarTimestamp() {
        const agora = new Date();
        document.getElementById('last-update').textContent = 
            `${agora.toLocaleDateString('pt-BR')} ${agora.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}`;
        
        document.getElementById('profile-active-indicator').classList.remove('hidden');
    }

    function mostrarNotificacao(mensagem, tipo = 'info') {
        const notificacao = document.createElement('div');
        notificacao.className = 'fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 animate-slide-in-right';
        
        const estilos = {
            success: 'bg-green-900/80 border-green-700 text-green-300',
            error: 'bg-red-900/80 border-red-700 text-red-300',
            warning: 'bg-yellow-900/80 border-yellow-700 text-yellow-300',
            info: 'bg-blue-900/80 border-blue-700 text-blue-300'
        };
        
        notificacao.className += ' ' + (estilos[tipo] || estilos.info);
        
        const icones = {
            success: 'check-circle',
            error: 'alert-circle',
            warning: 'alert-triangle',
            info: 'info'
        };
        
        notificacao.innerHTML = `
            <div class="flex items-center gap-3">
                <i data-lucide="${icones[tipo] || 'info'}" class="w-5 h-5"></i>
                <span>${mensagem}</span>
            </div>
        `;
        
        document.body.appendChild(notificacao);
        
        if (window.lucide) {
            lucide.createIcons();
        }
        
        setTimeout(() => {
            notificacao.classList.add('opacity-0', 'transition-opacity', 'duration-500');
            setTimeout(() => notificacao.remove(), 500);
        }, 3000);
    }

    // ====================================================================
    // INICIALIZAÇÃO
    // ====================================================================

    document.addEventListener('DOMContentLoaded', function() {
        inicializar();
        
        // Configurar variáveis CSS para cores
        const root = document.documentElement;
        root.style.setProperty('--theme-red', '#dc2626');
        root.style.setProperty('--theme-green', '#22c55e');
        root.style.setProperty('--theme-blue', '#4a9eff');
        root.style.setProperty('--theme-purple', '#8b5cf6');
        root.style.setProperty('--theme-yellow', '#f59e0b');
        root.style.setProperty('--theme-pink', '#ec4899');
        root.style.setProperty('--theme-orange', '#ff6b35');
        
        console.log('Sistema de Perfil inicializado com sucesso!');
    });

    // Adicionar função para calcular recursos manualmente
    function calcularRecursosManualmente() {
        calcularRecursos();
        mostrarNotificacao('Recursos recalculados com base nos atributos!', 'success');
    }

    // Renomear a função existente para maior clareza
    window.calcularRecursos = calcularRecursosManualmente;
    </script>
</body>
</html>